<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompeteBase PRO - Advanced Intelligence</title>
    
    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* PALETTE */
            --primary: #0f172a; --secondary: #334155; --accent: #2563eb; --accent-hover: #1d4ed8;
            --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text-main: #1e293b;
            --text-light: #64748b; 
            --swot-s: #dcfce7; --swot-s-text: #166534; /* Strengths - Green */
            --swot-w: #fee2e2; --swot-w-text: #991b1b; /* Weaknesses - Red */
            --swot-o: #dbeafe; --swot-o-text: #1e40af; /* Opportunities - Blue */
            --swot-t: #f1f5f9; --swot-t-text: #475569; /* Threats - Grey */
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- NAVBAR --- */
        .navbar { height: 64px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; gap: 20px; z-index: 50; }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; text-decoration: none; }
        
        .tabs { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 8px; margin-left: 40px; }
        .tab { padding: 6px 16px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; user-select: none; }
        .tab.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .nav-actions { display: flex; gap: 10px; margin-left: auto; }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: var(--accent-hover); }
        .btn-outline { border-color: var(--border); background: white; color: var(--text-main); }
        .btn-danger { background: #fee2e2; color: #dc2626; border-color: #fecaca; }

        /* --- LAYOUT --- */
        .layout { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR FILTERS */
        .sidebar { width: 280px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; flex-shrink: 0; }
        .filter-group { margin-bottom: 20px; }
        .filter-label { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px; display: block; }
        .sidebar-select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; color: var(--text-main); outline: none; background: #f8fafc; }
        .range-inputs { display: flex; gap: 10px; align-items: center; }
        .range-input { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }

        /* MAIN AREA */
        .main { flex: 1; padding: 24px; overflow-y: auto; background: var(--bg); position: relative; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD LIST --- */
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 300px; font-size: 13px; }
        
        .table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; text-align: left; padding: 14px; font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap; }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        
        .badge { padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
        .badge-na { background: #dbeafe; color: #1e40af; } 
        .badge-eu { background: #dcfce7; color: #166534; } 
        .badge-as { background: #fef9c3; color: #854d0e; }

        /* --- ANALYTICS --- */
        .top-players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .player-card { background: white; padding: 16px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .player-card h4 { margin: 0 0 10px 0; font-size: 12px; color: var(--text-light); text-transform: uppercase; }
        .player-card .value { font-size: 14px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .player-card .sub { font-size: 11px; color: var(--text-light); margin-top: 4px; }
        .player-icon { width: 30px; height: 30px; background: #eff6ff; color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); height: 350px; }

        /* --- SETTINGS --- */
        .settings-list { background: white; border: 1px solid var(--border); border-radius: 8px; }
        .setting-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        /* --- MODALS & DRAWERS --- */
        .drawer { position: fixed; top: 0; right: -600px; width: 600px; bottom: 0; background: white; z-index: 100; transition: right 0.3s ease; box-shadow: -5px 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; display: none; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 400px; padding: 24px; border-radius: 12px; text-align: center; }
        
        /* FULLSCREEN COMPARE */
        .compare-view { position: fixed; inset: 0; background: #f8fafc; z-index: 150; display: none; flex-direction: column; }
        .compare-view.open { display: flex; }
        .comp-header { padding: 15px 30px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .comp-table-wrapper { flex: 1; overflow: auto; padding: 30px; }
        .comp-table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .comp-table th { background: white; position: sticky; top: 0; z-index: 10; border-bottom: 3px solid var(--accent); padding: 20px; text-align: center; }
        .comp-table td { padding: 15px; border: 1px solid var(--border); vertical-align: top; font-size: 13px; word-wrap: break-word; }
        .comp-cat-row { background: #f1f5f9; font-weight: 800; text-transform: uppercase; padding-left: 20px; }
        
        .remove-col-btn { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 14px; margin-left: 10px; }
        .remove-col-btn:hover { color: #dc2626; }

        /* SWOT COLORS */
        .swot-s { background-color: var(--swot-s) !important; color: var(--swot-s-text); border-left: 4px solid #166534; }
        .swot-w { background-color: var(--swot-w) !important; color: var(--swot-w-text); border-left: 4px solid #991b1b; }
        .swot-o { background-color: var(--swot-o) !important; color: var(--swot-o-text); border-left: 4px solid #1e40af; }
        .swot-t { background-color: var(--swot-t) !important; color: var(--swot-t-text); border-left: 4px solid #475569; }

        .fab { position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: white; padding: 12px 24px; border-radius: 50px; font-weight: 600; cursor: pointer; box-shadow: 0 10px 20px rgba(37,99,235,0.3); display: none; align-items: center; gap: 10px; z-index: 80; }

    </style>
</head>
<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <a href="#" class="logo"><i class="fa-solid fa-chart-radar"></i> CompeteBase <span>PRO</span></a>
        
        <div class="tabs">
            <div class="tab active" onclick="switchView('list')">Home List</div>
            <div class="tab" onclick="switchView('analytics')">Analytics</div>
            <div class="tab" onclick="switchView('settings')">Settings</div>
        </div>

        <div class="nav-actions">
            <input type="file" id="fileInput" hidden accept=".xlsx" onchange="processExcel(this)">
            <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-upload"></i> Upload Excel
            </button>
            <button class="btn btn-accent" onclick="initDownload('selection')">
                <i class="fa-solid fa-download"></i> Download Selected
            </button>
        </div>
    </div>

    <div class="layout">
        <!-- SHARED SIDEBAR FILTERS -->
        <div class="sidebar">
            <h3 style="margin-top:0; font-size:14px; border-bottom:1px solid #eee; padding-bottom:10px;">Filters</h3>
            
            <div class="filter-group">
                <label class="filter-label">1. Geographic Region</label>
                <select id="f-region" class="sidebar-select" onchange="updateCountryFilter()">
                    <option value="All">All Regions</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">2. Country</label>
                <select id="f-country" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Countries</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">3. Industry</label>
                <select id="f-industry" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Industries</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">4. Employees</label>
                <div class="range-inputs">
                    <input type="number" id="f-emp-min" placeholder="Min" class="range-input" onkeyup="applyFilters()">
                    <input type="number" id="f-emp-max" placeholder="Max" class="range-input" onkeyup="applyFilters()">
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">5. Revenue ($M)</label>
                <div class="range-inputs">
                    <input type="number" id="f-rev-min" placeholder="Min" class="range-input" onkeyup="applyFilters()">
                    <input type="number" id="f-rev-max" placeholder="Max" class="range-input" onkeyup="applyFilters()">
                </div>
            </div>

            <button class="btn btn-outline" style="width:100%; justify-content:center;" onclick="resetFilters()">
                Reset Filters
            </button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            
            <!-- VIEW 1: HOME LIST -->
            <div id="list" class="view-section active">
                <div class="toolbar">
                    <input type="text" id="globalSearch" class="search-input" placeholder="Search by name, ID, or keyword..." onkeyup="applyFilters()">
                    <div style="font-size:13px; color:var(--text-light); padding-top:8px;">
                        Showing <b id="count-display">0</b> companies
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAllBox" onchange="toggleSelectAll(this)"></th>
                                <th width="100">ID</th>
                                <th width="200">Company Name</th>
                                <th width="120">Region</th>
                                <th width="150">Industry</th>
                                <th width="100">Employees</th>
                                <th width="100">Revenue</th>
                                <th width="80">Details</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- JS Renders Rows Here -->
                        </tbody>
                    </table>
                    <div id="empty-state" style="padding:40px; text-align:center; display:none; color:var(--text-light);">
                        No companies found. Upload data or adjust filters.
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ANALYTICS -->
            <div id="analytics" class="view-section">
                <!-- Top Players Grid -->
                <h3 style="margin-top:0;">Top Market Players</h3>
                <div class="top-players-grid">
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-trophy"></i></div>
                        <h4>Top Revenue</h4>
                        <div class="value" id="tp-rev">-</div>
                        <div class="sub" id="tp-rev-val"></div>
                    </div>
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-users"></i></div>
                        <h4>Largest Employer</h4>
                        <div class="value" id="tp-emp">-</div>
                        <div class="sub" id="tp-emp-val"></div>
                    </div>
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-truck"></i></div>
                        <h4>Most Distributors</h4>
                        <div class="value" id="tp-dist">-</div>
                        <div class="sub" id="tp-dist-val"></div>
                    </div>
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-clock"></i></div>
                        <h4>Oldest / Experienced</h4>
                        <div class="value" id="tp-exp">-</div>
                        <div class="sub" id="tp-exp-val"></div>
                    </div>
                     <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-warehouse"></i></div>
                        <h4>Most Warehouses</h4>
                        <div class="value" id="tp-ware">-</div>
                        <div class="sub" id="tp-ware-val"></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-row">
                    <div class="chart-box">
                        <h4>Market Share (Revenue)</h4>
                        <canvas id="chartRevenue"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Regional Distribution</h4>
                        <canvas id="chartRegion"></canvas>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: SETTINGS -->
            <div id="settings" class="view-section">
                <div class="settings-list" style="max-width:800px; margin:0 auto;">
                    <div class="setting-item" style="background:#fef2f2;">
                        <div>
                            <strong style="color:#dc2626;">Danger Zone</strong>
                            <div style="font-size:12px; color:#64748b;">Permanently delete specific companies.</div>
                        </div>
                    </div>
                    <div style="padding:20px;">
                        <input type="text" id="deleteSearch" placeholder="Enter Company ID or Name to delete..." class="search-input" style="width:100%;">
                        <div id="delete-list" style="margin-top:10px; max-height:300px; overflow:auto;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- FLOATING COMPARE BUTTON -->
    <div class="fab" id="compareFab" onclick="openCompareView()">
        <i class="fa-solid fa-scale-balanced"></i> Compare (<span id="compCount">0</span>)
    </div>

    <!-- DETAILS DRAWER -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="detailsDrawer">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
            <h2 id="d-name" style="margin:0;">Company</h2>
            <button class="btn btn-outline" onclick="closeDrawer()">Close</button>
        </div>
        <div id="d-content" style="padding:20px; overflow-y:auto;"></div>
    </div>

    <!-- COMPARISON VIEW (Fullscreen) -->
    <div class="compare-view" id="compareView">
        <div class="comp-header">
            <h3><i class="fa-solid fa-scale-balanced"></i> Comparison Analysis</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-accent" onclick="initDownload('comparison')">
                    <i class="fa-solid fa-download"></i> Download Comparison
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('compareView').classList.remove('open')">
                    Back to Dashboard
                </button>
            </div>
        </div>
        <div class="comp-table-wrapper">
            <table class="comp-table" id="compTable"></table>
        </div>
    </div>

    <!-- DOWNLOAD OPTION MODAL -->
    <div class="modal" id="dlModal">
        <div class="modal-box">
            <h3>Export Data</h3>
            <p>Select format for your download:</p>
            <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
                <button class="btn btn-outline" onclick="executeDownload('pdf')" style="flex-direction:column; padding:20px;">
                    <i class="fa-regular fa-file-pdf" style="font-size:24px; margin-bottom:5px;"></i>
                    PDF Report
                </button>
                <button class="btn btn-outline" onclick="executeDownload('excel')" style="flex-direction:column; padding:20px;">
                    <i class="fa-regular fa-file-excel" style="font-size:24px; margin-bottom:5px;"></i>
                    Excel Data
                </button>
            </div>
            <p style="font-size:11px; color:gray; margin-top:15px;">Note: PDF limited to max 5 companies.</p>
            <button class="btn btn-primary" style="margin-top:10px; width:100%;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const DB_KEY = 'compete_db_v1';
        let db = [];
        let filteredDB = [];
        let selectedIDs = new Set();
        let currentDlType = ''; // 'selection' or 'comparison'
        let charts = {};

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) db = JSON.parse(saved);
            filteredDB = [...db];
            populateFilterOptions();
            applyFilters();
            renderSettings();
        });

        // --- EXCEL PROCESSING ---
        function processExcel(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {defval:""});

                const newEntries = json.map(row => {
                    // Try to find specific columns, fallback to generic parsing
                    const name = row['Company Name'] || row['Name'] || 'Unknown';
                    // Persist ID if exists, else hash name
                    const id = row['Company ID'] || row['ID'] || Math.abs(strHash(name)).toString().substring(0,6); 
                    
                    // Parse Metrics
                    const loc = row['Headquarters'] || row['Location'] || row['Region'] || "Unknown";
                    let region = "Unknown", country = "Unknown";
                    
                    // Basic Geographic logic
                    const l = loc.toLowerCase();
                    if(l.includes('usa') || l.includes('united states') || l.includes('canada')) region = "North America";
                    else if(l.includes('china') || l.includes('india') || l.includes('japan') || l.includes('asia')) region = "Asia";
                    else if(l.includes('uk') || l.includes('germany') || l.includes('france') || l.includes('europe')) region = "Europe";
                    else region = loc; // Fallback

                    if(l.includes(',')) country = loc.split(',').pop().trim();
                    else country = loc;

                    const revStr = row['Revenue'] ? String(row['Revenue']) : "0";
                    const empStr = row['Employees'] ? String(row['Employees']) : "0";
                    
                    // Smart Extract for analytics
                    const distributors = extractNum(row['Distributors'] || row['Number of Distributors']);
                    const warehouses = extractNum(row['Warehouses'] || row['Number of Warehouses']);
                    const founded = extractNum(row['Year Established'] || row['Founded']);
                    const experience = founded > 0 ? (new Date().getFullYear() - founded) : 0;

                    // Convert row to Key-Value pairs for details
                    const details = [];
                    for(const [k, v] of Object.entries(row)) {
                        let cat = "General";
                        const kl = k.toLowerCase();
                        if(kl.includes('strength') || kl.includes('weakness') || kl.includes('opportun') || kl.includes('threat')) cat = "SWOT";
                        else if(kl.includes('revenue') || kl.includes('profit') || kl.includes('finance')) cat = "Financials";
                        else if(kl.includes('employee') || kl.includes('staff')) cat = "HR";
                        
                        details.push({ cat, key: k, val: String(v) });
                    }

                    return {
                        id: String(id),
                        name: name,
                        region: region,
                        country: country,
                        industry: row['Industry'] || row['Type of Company'] || "Other",
                        revenue: parseMoney(revStr),
                        employees: parseNum(empStr),
                        stats: { distributors, warehouses, experience },
                        data: details
                    };
                });

                // Merge: if ID exists, update, else add
                newEntries.forEach(ne => {
                    const idx = db.findIndex(x => x.id === ne.id);
                    if(idx >= 0) db[idx] = ne;
                    else db.push(ne);
                });

                saveDB();
                populateFilterOptions();
                applyFilters();
                alert(`Processed ${newEntries.length} companies.`);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- FILTERS & HIERARCHY ---
        function populateFilterOptions() {
            // Region
            const regions = [...new Set(db.map(x => x.region))].sort();
            fillSelect('f-region', regions);
            updateCountryFilter(); // Initial Cascade
            // Industry
            const inds = [...new Set(db.map(x => x.industry))].sort();
            fillSelect('f-industry', inds);
        }

        function updateCountryFilter() {
            const selRegion = document.getElementById('f-region').value;
            let available = db;
            if(selRegion !== 'All') available = db.filter(x => x.region === selRegion);
            
            const countries = [...new Set(available.map(x => x.country))].sort();
            fillSelect('f-country', countries);
            applyFilters();
        }

        function fillSelect(id, items) {
            const sel = document.getElementById(id);
            const current = sel.value;
            sel.innerHTML = '<option value="All">All ' + (id.split('-')[1] === 'region' ? 'Regions' : id.split('-')[1] === 'country' ? 'Countries' : 'Industries') + '</option>';
            items.forEach(i => sel.innerHTML += `<option value="${i}">${i}</option>`);
            if(items.includes(current)) sel.value = current;
        }

        function applyFilters() {
            const reg = document.getElementById('f-region').value;
            const cnt = document.getElementById('f-country').value;
            const ind = document.getElementById('f-industry').value;
            const empMin = parseFloat(document.getElementById('f-emp-min').value) || 0;
            const empMax = parseFloat(document.getElementById('f-emp-max').value) || Infinity;
            const revMin = parseFloat(document.getElementById('f-rev-min').value) || 0;
            const revMax = parseFloat(document.getElementById('f-rev-max').value) || Infinity;
            const search = document.getElementById('globalSearch').value.toLowerCase();

            filteredDB = db.filter(c => {
                if(reg !== 'All' && c.region !== reg) return false;
                if(cnt !== 'All' && c.country !== cnt) return false;
                if(ind !== 'All' && c.industry !== ind) return false;
                if(c.employees < empMin || c.employees > empMax) return false;
                if(c.revenue < revMin || c.revenue > revMax) return false;
                
                if(search) {
                    return c.name.toLowerCase().includes(search) || 
                           c.id.toLowerCase().includes(search) ||
                           c.industry.toLowerCase().includes(search);
                }
                return true;
            });

            document.getElementById('count-display').innerText = filteredDB.length;
            
            // Check current view to render
            if(document.getElementById('list').classList.contains('active')) renderTable();
            if(document.getElementById('analytics').classList.contains('active')) renderAnalytics();
        }

        function resetFilters() {
            document.querySelectorAll('select').forEach(s => s.value = 'All');
            document.querySelectorAll('.range-input').forEach(i => i.value = '');
            document.getElementById('globalSearch').value = '';
            populateFilterOptions();
            applyFilters();
        }

        // --- RENDER TABLE ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(filteredDB.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            }
            document.getElementById('empty-state').style.display = 'none';

            filteredDB.forEach(c => {
                let badge = 'badge-as';
                if(c.region === 'North America') badge = 'badge-na';
                if(c.region === 'Europe') badge = 'badge-eu';

                const tr = document.createElement('tr');
                tr.onclick = () => showDetails(c.id);
                tr.innerHTML = `
                    <td onclick="event.stopPropagation()" style="text-align:center;">
                        <input type="checkbox" class="row-cb" value="${c.id}" onchange="toggleSelect('${c.id}')" ${selectedIDs.has(c.id)?'checked':''}>
                    </td>
                    <td style="color:var(--text-light); font-family:monospace;">${c.id}</td>
                    <td style="font-weight:600; color:var(--primary);">${c.name}</td>
                    <td><span class="badge ${badge}">${c.region}</span></td>
                    <td>${c.industry}</td>
                    <td>${c.employees.toLocaleString()}</td>
                    <td>$${c.revenue.toLocaleString()}M</td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn btn-outline" style="padding:4px 10px; font-size:11px;" onclick="showDetails('${c.id}')">View</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            checkSelectAllBox();
        }

        // --- RENDER ANALYTICS ---
        function renderAnalytics() {
            // 1. Top Players Cards
            const getTop = (key, formatCb) => {
                const sorted = [...filteredDB].sort((a,b) => {
                    // Handle nested stats vs root props
                    let valA = a.stats[key] !== undefined ? a.stats[key] : a[key];
                    let valB = b.stats[key] !== undefined ? b.stats[key] : b[key];
                    return valB - valA;
                });
                if(sorted.length && (sorted[0][key] > 0 || sorted[0].stats[key] > 0)) {
                    let val = sorted[0].stats[key] !== undefined ? sorted[0].stats[key] : sorted[0][key];
                    return { name: sorted[0].name, val: formatCb ? formatCb(val) : val };
                }
                return { name: '-', val: '-' };
            };

            const topRev = getTop('revenue', v => `$${v.toLocaleString()}M`);
            document.getElementById('tp-rev').innerText = topRev.name;
            document.getElementById('tp-rev-val').innerText = topRev.val;

            const topEmp = getTop('employees', v => `${v.toLocaleString()} emp`);
            document.getElementById('tp-emp').innerText = topEmp.name;
            document.getElementById('tp-emp-val').innerText = topEmp.val;

            const topDist = getTop('distributors', v => `${v} dist`);
            document.getElementById('tp-dist').innerText = topDist.name;
            document.getElementById('tp-dist-val').innerText = topDist.val;

            const topExp = getTop('experience', v => `${v} years`);
            document.getElementById('tp-exp').innerText = topExp.name;
            document.getElementById('tp-exp-val').innerText = topExp.val;

            const topWare = getTop('warehouses', v => `${v} sites`);
            document.getElementById('tp-ware').innerText = topWare.name;
            document.getElementById('tp-ware-val').innerText = topWare.val;

            // 2. Charts
            renderCharts();
        }

        function renderCharts() {
            // Revenue Share
            const ctxRev = document.getElementById('chartRevenue');
            const top5Rev = [...filteredDB].sort((a,b) => b.revenue - a.revenue).slice(0, 5);
            
            if(charts.rev) charts.rev.destroy();
            charts.rev = new Chart(ctxRev, {
                type: 'doughnut',
                data: {
                    labels: top5Rev.map(c => c.name),
                    datasets: [{ data: top5Rev.map(c => c.revenue), backgroundColor: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position:'right' } } }
            });

            // Regional Count
            const ctxReg = document.getElementById('chartRegion');
            const regCounts = {};
            filteredDB.forEach(c => regCounts[c.region] = (regCounts[c.region]||0)+1);
            
            if(charts.reg) charts.reg.destroy();
            charts.reg = new Chart(ctxReg, {
                type: 'bar',
                data: {
                    labels: Object.keys(regCounts),
                    datasets: [{ label: 'Companies', data: Object.values(regCounts), backgroundColor: '#0f172a', borderRadius:4 }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        // --- COMPARISON LOGIC ---
        function openCompareView() {
            if(selectedIDs.size < 2) return alert("Select at least 2 companies to compare.");
            
            const comps = db.filter(c => selectedIDs.has(c.id));
            const table = document.getElementById('compTable');
            
            // Build Matrix
            // 1. Gather all unique data keys
            const keyMap = {}; // Cat -> Set(Keys)
            comps.forEach(c => {
                c.data.forEach(d => {
                    if(!keyMap[d.cat]) keyMap[d.cat] = new Set();
                    keyMap[d.cat].add(d.key);
                });
            });

            // Header
            let html = `<thead><tr><th style="left:0; z-index:20; min-width:150px;">Data Point</th>`;
            comps.forEach(c => {
                html += `<th>
                    ${c.name}
                    <button class="remove-col-btn" onclick="removeFromCompare('${c.id}')"><i class="fa-solid fa-xmark"></i></button>
                </th>`;
            });
            html += `</tr></thead><tbody>`;

            // Fixed Rows (Revenue, Emp)
            html += `<tr class="comp-cat-row"><td colspan="${comps.length+1}">Overview</td></tr>`;
            html += `<tr><td><b>Region</b></td>${comps.map(c=>`<td>${c.region}</td>`).join('')}</tr>`;
            html += `<tr><td><b>Revenue</b></td>${comps.map(c=>`<td>$${c.revenue.toLocaleString()}M</td>`).join('')}</tr>`;
            html += `<tr><td><b>Employees</b></td>${comps.map(c=>`<td>${c.employees.toLocaleString()}</td>`).join('')}</tr>`;

            // Dynamic Rows
            for(const [cat, keys] of Object.entries(keyMap)) {
                html += `<tr class="comp-cat-row"><td colspan="${comps.length+1}">${cat}</td></tr>`;
                keys.forEach(k => {
                    let rowClass = "";
                    const kl = k.toLowerCase();
                    // SWOT Coloring Logic based on key or category
                    if(cat === 'SWOT') {
                        if(kl.includes('strength')) rowClass = 'swot-s';
                        else if(kl.includes('weakness')) rowClass = 'swot-w';
                        else if(kl.includes('opportun')) rowClass = 'swot-o';
                        else if(kl.includes('threat')) rowClass = 'swot-t';
                    }
                    
                    html += `<tr><td class="${rowClass}"><b>${k}</b></td>`;
                    comps.forEach(c => {
                        const dp = c.data.find(d => d.cat === cat && d.key === k);
                        html += `<td class="${rowClass}">${dp ? dp.val : '-'}</td>`;
                    });
                    html += `</tr>`;
                });
            }

            table.innerHTML = html + "</tbody>";
            document.getElementById('compareView').classList.add('open');
        }

        function removeFromCompare(id) {
            toggleSelect(id);
            if(selectedIDs.size < 1) {
                document.getElementById('compareView').classList.remove('open');
            } else {
                openCompareView(); // Re-render
            }
        }

        // --- EXPORT / DOWNLOAD ---
        function initDownload(type) {
            // Check selections
            if(selectedIDs.size === 0) return alert("No companies selected.");
            currentDlType = type;
            document.getElementById('dlModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('dlModal').style.display = 'none'; }

        function executeDownload(format) {
            closeModal();
            const targets = db.filter(c => selectedIDs.has(c.id));
            
            if(format === 'pdf') {
                if(targets.length > 5) return alert("PDF export allows maximum 5 companies. Please use Excel for larger datasets.");
                generatePDF(targets);
            } else {
                generateExcel(targets);
            }
        }

        function generateExcel(data) {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Summary
            const summaryData = data.map(c => ({
                "ID": c.id, "Name": c.name, "Region": c.region, "Industry": c.industry,
                "Revenue ($M)": c.revenue, "Employees": c.employees
            }));
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

            // Sheet 2: End-to-End Flat Data
            const flatData = data.map(c => {
                const flat = { "ID": c.id, "Name": c.name };
                c.data.forEach(d => flat[`${d.cat} - ${d.key}`] = d.val);
                return flat;
            });
            const wsFull = XLSX.utils.json_to_sheet(flatData);
            XLSX.utils.book_append_sheet(wb, wsFull, "Detailed Data");

            XLSX.writeFile(wb, "Competitor_Analysis_Export.xlsx");
        }

        function generatePDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("Competitor Analysis Report", 14, 20);
            
            data.forEach((c, index) => {
                if(index > 0) doc.addPage();
                doc.setFontSize(14);
                doc.text(`${c.name} (${c.id})`, 14, 30);
                doc.setFontSize(10);
                doc.text(`Region: ${c.region} | Revenue: $${c.revenue}M | Emp: ${c.employees}`, 14, 36);
                
                // Table data
                const rows = c.data.map(d => [d.cat, d.key, d.val]);
                doc.autoTable({
                    startY: 40,
                    head: [['Category', 'Metric', 'Value']],
                    body: rows,
                    theme: 'grid'
                });
            });
            
            doc.save("Competitor_Report.pdf");
        }

        // --- SETTINGS / DELETION ---
        function renderSettings() {
            const input = document.getElementById('deleteSearch');
            input.onkeyup = () => {
                const q = input.value.toLowerCase();
                const list = document.getElementById('delete-list');
                list.innerHTML = '';
                if(q.length < 2) return;

                const matches = db.filter(c => c.name.toLowerCase().includes(q) || c.id.toLowerCase().includes(q));
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.style.padding = "10px";
                    div.style.borderBottom = "1px solid #eee";
                    div.style.display = "flex";
                    div.style.justifyContent = "space-between";
                    div.innerHTML = `<span><b>${m.name}</b> (${m.id})</span> <button class="btn btn-danger" style="padding:4px 8px; font-size:10px;">Delete</button>`;
                    div.querySelector('button').onclick = () => deleteCompany(m.id);
                    list.appendChild(div);
                });
            }
        }

        function deleteCompany(id) {
            if(!confirm("Are you sure? This cannot be undone.")) return;
            db = db.filter(c => c.id !== id);
            saveDB();
            location.reload();
        }

        // --- UTILS & HELPERS ---
        function toggleSelectAll(source) {
            document.querySelectorAll('.row-cb').forEach(cb => {
                cb.checked = source.checked;
                toggleSelect(cb.value, false);
            });
            updateFab();
        }

        function toggleSelect(id, updateUI=true) {
            if(selectedIDs.has(id)) selectedIDs.delete(id);
            else selectedIDs.add(id);
            if(updateUI) updateFab();
        }

        function checkSelectAllBox() {
            const all = filteredDB.length > 0 && filteredDB.every(c => selectedIDs.has(c.id));
            document.getElementById('selectAllBox').checked = all;
        }

        function updateFab() {
            document.getElementById('compCount').innerText = selectedIDs.size;
            document.getElementById('compareFab').style.display = selectedIDs.size > 0 ? 'flex' : 'none';
        }

        function showDetails(id) {
            const c = db.find(x => x.id === id);
            if(!c) return;
            document.getElementById('d-name').innerText = c.name;
            const con = document.getElementById('d-content');
            
            // Group Data
            const groups = {};
            c.data.forEach(d => {
                if(!groups[d.cat]) groups[d.cat] = [];
                groups[d.cat].push(d);
            });

            let html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div class="player-card"><b>ID:</b> ${c.id}</div>
                <div class="player-card"><b>Region:</b> ${c.region}</div>
                <div class="player-card"><b>Revenue:</b> $${c.revenue}M</div>
                <div class="player-card"><b>Employees:</b> ${c.employees}</div>
            </div>`;

            for(const [cat, items] of Object.entries(groups)) {
                let catStyle = "";
                if(cat==='SWOT') catStyle = "border-left:4px solid var(--accent); padding-left:10px;";
                html += `<div style="margin-bottom:20px; ${catStyle}"><h4 style="margin-bottom:5px; color:var(--text-light); text-transform:uppercase; font-size:12px;">${cat}</h4>`;
                items.forEach(i => {
                    let valClass = "";
                    if(cat === 'SWOT') {
                        if(i.key.includes('Strength')) valClass = "swot-s";
                        if(i.key.includes('Weakness')) valClass = "swot-w";
                    }
                    html += `<div style="display:flex; justify-content:space-between; font-size:13px; padding:6px 0; border-bottom:1px solid #f1f5f9;">
                        <span style="font-weight:500;">${i.key}</span>
                        <span class="${valClass}" style="max-width:50%; text-align:right; ${valClass?'padding:2px 6px; border-radius:4px;':''}">${i.val}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            con.innerHTML = html;
            document.getElementById('drawerOverlay').style.display = 'block';
            setTimeout(() => document.getElementById('detailsDrawer').classList.add('open'), 10);
        }

        function closeDrawer() {
            document.getElementById('detailsDrawer').classList.remove('open');
            setTimeout(() => document.getElementById('drawerOverlay').style.display = 'none', 300);
        }

        function switchView(view) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active'); // Note: this relies on event bubbling logic or specific targeting
            document.getElementById(view).classList.add('active');
            if(view === 'analytics') renderAnalytics();
            if(view === 'list') renderTable();
        }

        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        
        // Helpers
        function strHash(s) { let h=0; for(let i=0;i<s.length;i++) h = Math.imul(31,h)+s.charCodeAt(i)|0; return h; }
        function parseMoney(s) { const m = s.match(/(\d+(\.\d+)?)/); return m ? parseFloat(m[0]) : 0; }
        function parseNum(s) { return parseInt(s.replace(/,/g,'')) || 0; }
        function extractNum(val) {
            if(!val) return 0;
            const match = String(val).match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }

    </script>
</body>
</html>