<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompeteBase PRO</title>
    
    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #2563eb; --accent-hover: #1d4ed8;
            --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text-main: #1e293b;
            --text-light: #64748b; 
            /* SWOT Colors */
            --swot-s: #dcfce7; --swot-s-text: #166534; 
            --swot-w: #fee2e2; --swot-w-text: #991b1b; 
            --swot-o: #dbeafe; --swot-o-text: #1e40af; 
            --swot-t: #f1f5f9; --swot-t-text: #475569; 
            /* Chart Colors */
            --chart-1: #2563eb; --chart-2: #3b82f6; --chart-3: #60a5fa; --chart-4: #93c5fd; --chart-5: #bfdbfe;
            --chart-6: #10b981; --chart-7: #22c55e; --chart-8: #84cc19; --chart-9: #eab308; --chart-10: #f59e0b;
            --chart-11: #64748b; 
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* NAVBAR */
        .navbar { height: 70px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; gap: 20px; z-index: 50; }
        .logo { font-family: 'Outfit', sans-serif; font-size: 24px; font-weight: 800; text-decoration: none; background: -webkit-linear-gradient(45deg, #2563eb, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px; }
        
        .tabs { display: flex; gap: 5px; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-left: 40px; }
        .tab { padding: 8px 20px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; user-select: none; }
        .tab.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .nav-actions { display: flex; gap: 10px; margin-left: auto; }
        .btn { padding: 10px 18px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { border-color: var(--border); background: white; color: var(--text-main); }
        .btn-danger { background: #fee2e2; color: #dc2626; border-color: #fecaca; }

        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; flex-shrink: 0; }
        .main { flex: 1; padding: 24px; overflow-y: auto; background: var(--bg); position: relative; }
        
        /* FILTERS */
        .filter-group { margin-bottom: 20px; }
        .filter-label { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px; display: block; }
        .sidebar-select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: #f8fafc; outline: none; }
        .range-inputs { display: flex; gap: 10px; align-items: center; }
        .range-input { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }

        /* VIEWS */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* TABLE */
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 300px; font-size: 13px; }
        .table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; }
        
        /* SORTABLE HEADERS */
        th { background: linear-gradient(to bottom, #ffffff, #f8fafc); text-align: left; padding: 14px; font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; transition: background 0.2s; }
        th:hover { background: #f1f5f9; color: var(--primary); }
        th i { margin-left: 5px; opacity: 0.5; }
        th.sorted-asc i, th.sorted-desc i { opacity: 1; color: var(--accent); }

        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
        .badge-na { background: #dbeafe; color: #1e40af; } 
        .badge-eu { background: #dcfce7; color: #166534; } 
        .badge-as { background: #fef9c3; color: #854d0e; }

        /* ANALYTICS */
        .top-players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .player-card { background: white; padding: 16px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .player-card h4 { margin: 0 0 10px 0; font-size: 12px; color: var(--text-light); text-transform: uppercase; }
        .player-card .value { font-size: 14px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .player-card .sub { font-size: 11px; color: var(--text-light); margin-top: 4px; }
        .player-icon { width: 30px; height: 30px; background: #eff6ff; color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); height: 350px; }

        /* COMPARISON */
        .compare-view { position: fixed; inset: 0; background: #f8fafc; z-index: 150; display: none; flex-direction: column; }
        .compare-view.open { display: flex; }
        .comp-header { padding: 15px 30px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .comp-table-wrapper { flex: 1; overflow: auto; padding: 30px; }
        .comp-table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .comp-table th { background: white; position: sticky; top: 0; z-index: 10; border-bottom: 3px solid var(--accent); padding: 15px; min-width: 220px; }
        .comp-header-content { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; }
        .comp-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; font-weight: 700; }
        
        .comp-table td { padding: 15px; border: 1px solid var(--border); vertical-align: top; font-size: 13px; word-wrap: break-word; }
        .comp-cat-row { background: #f1f5f9; font-weight: 800; text-transform: uppercase; padding-left: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .dp-icon { width: 24px; height: 24px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; flex-shrink: 0; }
        .remove-col-btn { color: #94a3b8; background: none; border: none; cursor: pointer; font-size: 14px; padding: 5px; flex-shrink: 0; transition: 0.2s; }
        .remove-col-btn:hover { color: #ef4444; background: #fee2e2; border-radius: 50%; }

        /* CHATBOT */
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .chat-fab { position: fixed; bottom: 100px; right: 30px; background: var(--accent); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 10px 20px rgba(37,99,235,0.3); z-index: 80; animation: pulse 2s infinite; transition: transform 0.2s; }
        .chat-fab:hover { transform: scale(1.1); animation: none; }
        .chat-window { position: fixed; bottom: 170px; right: 30px; width: 350px; height: 450px; background: white; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); z-index: 90; display: none; flex-direction: column; overflow: hidden; border: 1px solid var(--border); }
        .chat-header { background: var(--primary); color: white; padding: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .chat-header span:first-child { display: flex; align-items: center; gap: 10px; }
        .chat-header i { color: var(--accent); } /* Color for robot icon */
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 5px; background: white; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 80%; font-size: 13px; line-height: 1.4; }
        .msg-user { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        .msg-bot { background: #e2e8f0; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 0; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 400px; padding: 24px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        
        /* DRAWER */
        .drawer { position: fixed; top: 0; right: -600px; width: 600px; bottom: 0; background: white; z-index: 100; transition: right 0.3s ease; box-shadow: -5px 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; display: none; }

        .fab { position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: white; padding: 12px 24px; border-radius: 50px; font-weight: 600; cursor: pointer; box-shadow: 0 10px 20px rgba(37,99,235,0.3); display: none; align-items: center; gap: 10px; z-index: 80; }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <a href="#" class="logo">
            <i class="fa-solid fa-layer-group"></i> CompeteBase
        </a>
        
        <div class="tabs">
            <div class="tab active" onclick="switchView('list')">Home List</div>
            <div class="tab" onclick="switchView('analytics')">Analytics</div>
            <div class="tab" onclick="switchView('settings')">Settings</div>
        </div>

        <div class="nav-actions">
            <input type="file" id="fileInput" hidden accept=".xlsx" onchange="processExcel(this)">
            <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-upload"></i> Upload Excel
            </button>
            <button class="btn btn-accent" onclick="initDownload('selection')">
                <i class="fa-solid fa-download"></i> Download Selected
            </button>
        </div>
    </div>

    <div class="layout">
        <!-- SIDEBAR FILTERS -->
        <div class="sidebar">
            <h3 style="margin-top:0; font-size:14px; border-bottom:1px solid #eee; padding-bottom:10px;">Filters</h3>
            
            <div class="filter-group">
                <label class="filter-label">1. Geographic Region</label>
                <select id="f-region" class="sidebar-select" onchange="updateCountryFilter()">
                    <option value="All">All Regions</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">2. Country</label>
                <select id="f-country" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Countries</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">3. Core Products</label>
                <select id="f-core" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Products</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">4. Industry</label>
                <select id="f-industry" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Industries</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">5. Employees</label>
                <div class="range-inputs">
                    <input type="number" id="f-emp-min" placeholder="Min" class="range-input" onkeyup="applyFilters()">
                    <input type="number" id="f-emp-max" placeholder="Max" class="range-input" onkeyup="applyFilters()">
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">6. Revenue ($M)</label>
                <div class="range-inputs">
                    <input type="number" id="f-rev-min" placeholder="Min" class="range-input" onkeyup="applyFilters()">
                    <input type="number" id="f-rev-max" placeholder="Max" class="range-input" onkeyup="applyFilters()">
                </div>
            </div>

            <button class="btn btn-outline" style="width:100%; justify-content:center;" onclick="resetFilters()">
                Reset Filters
            </button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            
            <!-- VIEW 1: HOME LIST -->
            <div id="list" class="view-section active">
                <div class="toolbar">
                    <input type="text" id="globalSearch" class="search-input" placeholder="Search by name, ID, or keyword..." onkeyup="applyFilters()">
                    <div style="font-size:13px; color:var(--text-light); padding-top:8px;">
                        Showing <b id="count-display">0</b> companies
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAllBox" onchange="toggleSelectAll(this)"></th>
                                <th onclick="sortDB('id')">ID <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('name')">Company Name <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('region')">Region <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('coreProduct')">Core Product <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('industry')">Industry <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('employees')">Employees <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('revenue')">Revenue <i class="fa-solid fa-sort"></i></th>
                                <th width="80">Details</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- JS Renders Rows Here -->
                        </tbody>
                    </table>
                    <div id="empty-state" style="padding:40px; text-align:center; display:none; color:var(--text-light);">
                        No companies found. Upload Excel data.
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ANALYTICS -->
            <div id="analytics" class="view-section">
                <!-- Top Players Grid -->
                <h3 style="margin-top:0;">Top Market Players</h3>
                <div class="top-players-grid">
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-trophy"></i></div>
                        <h4>Top Revenue</h4>
                        <div class="value" id="tp-rev">-</div>
                        <div class="sub" id="tp-rev-val"></div>
                    </div>
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-users"></i></div>
                        <h4>Largest Employer</h4>
                        <div class="value" id="tp-emp">-</div>
                        <div class="sub" id="tp-emp-val"></div>
                    </div>
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-truck"></i></div>
                        <h4>Most Distributors</h4>
                        <div class="value" id="tp-dist">-</div>
                        <div class="sub" id="tp-dist-val"></div>
                    </div>
                    <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-clock"></i></div>
                        <h4>Oldest / Experienced</h4>
                        <div class="value" id="tp-exp">-</div>
                        <div class="sub" id="tp-exp-val"></div>
                    </div>
                     <div class="player-card">
                        <div class="player-icon"><i class="fa-solid fa-warehouse"></i></div>
                        <h4>Most Warehouses</h4>
                        <div class="value" id="tp-ware">-</div>
                        <div class="sub" id="tp-ware-val"></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-row">
                    <div class="chart-box">
                        <h4>Market Share (Revenue)</h4>
                        <canvas id="chartRevenue"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Regional Distribution</h4>
                        <canvas id="chartRegion"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Employee Count Distribution</h4>
                        <canvas id="chartEmployees"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Distributor Count Distribution</h4>
                        <canvas id="chartDistributors"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Warehouse Count Distribution</h4>
                        <canvas id="chartWarehouses"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Core Product Distribution</h4>
                        <canvas id="chartCoreProducts"></canvas>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: SETTINGS -->
            <div id="settings" class="view-section">
                <div class="settings-list" style="max-width:800px; margin:0 auto; border:1px solid #e2e8f0; border-radius:8px;">
                    <div style="background:#fef2f2; padding:15px; border-bottom:1px solid #e2e8f0;">
                        <strong style="color:#dc2626;">Danger Zone</strong>
                        <div style="font-size:12px; color:#64748b;">Permanently delete specific companies.</div>
                    </div>
                    <div style="padding:20px;">
                        <input type="text" id="deleteSearch" placeholder="Type name or ID to search..." class="search-input" style="width:100%;" onkeyup="renderSettings()">
                        <div id="delete-list" style="margin-top:10px; max-height:300px; overflow:auto;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- AI CHATBOT -->
    <div class="chat-fab" onclick="toggleChat()">
        <i class="fa-solid fa-robot"></i>
    </div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <span><i class="fa-solid fa-robot"></i> CompeteAI</span>
            <span onclick="toggleChat()" style="cursor:pointer;">&times;</span>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="msg msg-bot">Hello! I'm your data assistant. Ask me things like "Who has the most employees?" or "Summarize Enerpac".</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ask a question..." style="flex:1; border:none; outline:none;" onkeypress="handleChatEnter(event)">
            <button class="btn btn-accent" style="padding:8px;" onclick="handleChat()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- FLOATING COMPARE BUTTON -->
    <div class="fab" id="compareFab" onclick="openCompareView()">
        <i class="fa-solid fa-scale-balanced"></i> Compare (<span id="compCount">0</span>)
    </div>

    <!-- DETAILS DRAWER -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="detailsDrawer">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
            <h2 id="d-name" style="margin:0;">Company</h2>
            <button class="btn btn-outline" onclick="closeDrawer()">Close</button>
        </div>
        <div id="d-content" style="padding:20px; overflow-y:auto;"></div>
    </div>

    <!-- COMPARISON VIEW (Fullscreen) -->
    <div class="compare-view" id="compareView">
        <div class="comp-header">
            <h3><i class="fa-solid fa-scale-balanced"></i> Comparison Analysis</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" style="border-style:dashed; color:var(--accent); border-color:var(--accent);" onclick="openAddModal()">
                    <i class="fa-solid fa-plus"></i> Add Company
                </button>
                <button class="btn btn-accent" onclick="initDownload('comparison')">
                    <i class="fa-solid fa-download"></i> Download Comparison
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('compareView').classList.remove('open')">
                    Back to Dashboard
                </button>
            </div>
        </div>
        <div class="comp-table-wrapper">
            <table class="comp-table" id="compTable"></table>
        </div>
    </div>

    <!-- ADD COMPANY MODAL (Inside Compare View) -->
    <div class="modal" id="addModal">
        <div class="modal-box">
            <h3>Add to Comparison</h3>
            <input type="text" id="addSearch" class="search-input" style="width:100%; margin-bottom:10px;" placeholder="Search company..." onkeyup="renderAddList()">
            <div id="add-list" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:6px;"></div>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="document.getElementById('addModal').style.display='none'">Cancel</button>
        </div>
    </div>

    <!-- DOWNLOAD OPTION MODAL -->
    <div class="modal" id="dlModal">
        <div class="modal-box">
            <h3>Export Data</h3>
            <p>Select format for your download:</p>
            <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
                <button class="btn btn-outline" onclick="executeDownload('pdf')" style="flex-direction:column; padding:20px;">
                    <i class="fa-regular fa-file-pdf" style="font-size:24px; margin-bottom:5px;"></i>
                    PDF Report
                </button>
                <button class="btn btn-outline" onclick="executeDownload('excel')" style="flex-direction:column; padding:20px;">
                    <i class="fa-regular fa-file-excel" style="font-size:24px; margin-bottom:5px;"></i>
                    Excel Data
                </button>
            </div>
            <p style="font-size:11px; color:gray; margin-top:15px;">Note: PDF limited to max 5 companies.</p>
            <button class="btn btn-primary" style="margin-top:10px; width:100%;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const DB_KEY = 'compete_db_v5';
        let db = [];
        let filteredDB = [];
        let selectedIDs = new Set();
        let currentDlType = ''; 
        let currentSort = { col: null, dir: 'asc' };
        let charts = {};
        let chatHistory = []; // Store chat messages

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) db = JSON.parse(saved);
            filteredDB = [...db];
            populateFilterOptions();
            applyFilters();
            renderSettings();
            updateFab();
        });

        // --- EXCEL PROCESSING ---
        function processExcel(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval:""});
                
                if(rows.length < 3) return alert("File too short");

                const companies = [];
                const companyStartIndex = 2;

                for(let c = companyStartIndex; c < rows[0].length; c++) {
                    let nameRowIndex = rows.findIndex(r => (r[1]||"").toLowerCase().trim() === 'company name');
                    if(nameRowIndex === -1) nameRowIndex = 2; 
                    if(!rows[nameRowIndex][c]) continue; 

                    companies.push({
                        tempIdx: c,
                        id: "",
                        name: "",
                        region: "Unknown",
                        country: "Unknown",
                        industry: "Unknown",
                        coreProduct: "-",
                        revenue: 0,
                        employees: 0,
                        stats: { distributors: 0, warehouses: 0, experience: 0 },
                        data: []
                    });
                }

                for(let r = 0; r < rows.length; r++) {
                    const cat = (rows[r][0] || "").trim();
                    const key = (rows[r][1] || "").trim();
                    if(!key) continue;

                    companies.forEach(comp => {
                        let val = (rows[r][comp.tempIdx]);
                        if(val === undefined || val === null) val = "-";
                        val = String(val).trim();

                        if(val && val !== "-") {
                            comp.data.push({ cat: cat || "General", key: key, val: val });
                        }

                        const kl = key.toLowerCase();
                        if(kl === 'company name') comp.name = val;
                        if(kl === 'company id') comp.id = val;
                        if(kl.includes('core product')) comp.coreProduct = val;
                        if(kl === 'industry' || kl === 'type of company') comp.industry = val;
                        
                        if(kl === 'headquarters' || kl === 'location') {
                            const l = val.toLowerCase();
                            if(l.includes('usa') || l.includes('united states') || l.includes('canada')) comp.region = "North America";
                            else if(l.includes('china') || l.includes('india') || l.includes('asia')) comp.region = "Asia";
                            else if(l.includes('europe') || l.includes('uk') || l.includes('germany')) comp.region = "Europe";
                            else comp.region = val; 

                            if(val.includes(',')) comp.country = val.split(',').pop().trim();
                            else comp.country = val;
                        }

                        if(kl.includes('revenue')) comp.revenue = parseMoney(val);
                        if((kl.includes('employee') || kl.includes('staff')) && !kl.includes('range')) {
                            comp.employees = parseNum(val);
                        }

                        if(kl.includes('distributors')) comp.stats.distributors = extractNum(val);
                        if(kl.includes('warehouses')) comp.stats.warehouses = extractNum(val);
                        if(kl.includes('established') || kl.includes('founded')) {
                            const yr = extractNum(val);
                            if(yr > 1000) comp.stats.experience = new Date().getFullYear() - yr;
                        }
                    });
                }

                companies.forEach(c => {
                    if(!c.id || c.id === '-') c.id = Math.abs(strHash(c.name)).toString().substring(0,6);
                    delete c.tempIdx;
                });

                companies.forEach(ne => {
                    const idx = db.findIndex(x => x.id === ne.id);
                    if(idx >= 0) db[idx] = ne;
                    else db.push(ne);
                });

                saveDB();
                populateFilterOptions();
                applyFilters();
                switchView('list');
                alert(`Processed ${companies.length} competitors.`);
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        // --- SORTING ---
        function sortDB(col) {
            if (col === 'Details') return; // No sorting for Details column
            if (col === 'id') col = 'id'; // Ensure ID is treated as string
            if (col === 'name') col = 'name';
            if (col === 'region') col = 'region';
            if (col === 'coreProduct') col = 'coreProduct';
            if (col === 'industry') col = 'industry';
            if (col === 'employees') col = 'employees';
            if (col === 'revenue') col = 'revenue';

            // Toggle Dir
            if(currentSort.col === col) {
                currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = { col: col, dir: 'asc' };
            }

            // Update UI Icons
            document.querySelectorAll('th').forEach(th => th.className = '');
            const clickedTh = document.querySelector(`th[onclick="sortDB('${col}')"]`);
            if(clickedTh) clickedTh.classList.add(`sorted-${currentSort.dir}`);

            // Sort
            filteredDB.sort((a, b) => {
                let valA = a[col];
                let valB = b[col];

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        // --- FILTERS ---
        function populateFilterOptions() {
            const regions = [...new Set(db.map(x => x.region))].sort();
            fillSelect('f-region', regions);
            updateCountryFilter(); 
            
            const rawProds = db.map(x => x.coreProduct).filter(Boolean);
            const splitProds = rawProds.flatMap(p => p.split(',').map(s => s.trim()));
            const uniqueProds = [...new Set(splitProds)].sort();
            fillSelect('f-core', uniqueProds);

            const inds = [...new Set(db.map(x => x.industry))].sort();
            fillSelect('f-industry', inds);
        }

        function updateCountryFilter() {
            const selRegion = document.getElementById('f-region').value;
            let available = db;
            if(selRegion !== 'All') available = db.filter(x => x.region === selRegion);
            
            const countries = [...new Set(available.map(x => x.country))].sort();
            fillSelect('f-country', countries);
            applyFilters();
        }

        function fillSelect(id, items) {
            const sel = document.getElementById(id);
            const current = sel.value;
            let label = "Items";
            if(id.includes('region')) label = "Regions";
            if(id.includes('country')) label = "Countries";
            if(id.includes('core')) label = "Products";
            if(id.includes('industry')) label = "Industries";

            sel.innerHTML = `<option value="All">All ${label}</option>`;
            items.forEach(i => {
                if(i && i !== '-') sel.innerHTML += `<option value="${i}">${i}</option>`;
            });
            if(items.includes(current)) sel.value = current;
        }

        function applyFilters() {
            const reg = document.getElementById('f-region').value;
            const cnt = document.getElementById('f-country').value;
            const core = document.getElementById('f-core').value;
            const ind = document.getElementById('f-industry').value;
            
            const empMin = parseFloat(document.getElementById('f-emp-min').value) || 0;
            const empMax = parseFloat(document.getElementById('f-emp-max').value) || Infinity;
            const revMin = parseFloat(document.getElementById('f-rev-min').value) || 0;
            const revMax = parseFloat(document.getElementById('f-rev-max').value) || Infinity;
            
            const search = document.getElementById('globalSearch').value.toLowerCase();

            filteredDB = db.filter(c => {
                if(reg !== 'All' && c.region !== reg) return false;
                if(cnt !== 'All' && c.country !== cnt) return false;
                
                if(core !== 'All') {
                    if(!c.coreProduct.toLowerCase().includes(core.toLowerCase())) return false;
                }

                if(ind !== 'All' && c.industry !== ind) return false;
                if(c.employees < empMin || c.employees > empMax) return false;
                if(c.revenue < revMin || c.revenue > revMax) return false;
                
                if(search) {
                    return c.name.toLowerCase().includes(search) || 
                           c.id.toLowerCase().includes(search) ||
                           c.coreProduct.toLowerCase().includes(search);
                }
                return true;
            });

            document.getElementById('count-display').innerText = filteredDB.length;
            
            if(document.getElementById('list').classList.contains('active')) renderTable();
            if(document.getElementById('analytics').classList.contains('active')) renderAnalytics();
        }

        function resetFilters() {
            document.querySelectorAll('select').forEach(s => s.value = 'All');
            document.querySelectorAll('.range-input').forEach(i => i.value = '');
            document.getElementById('globalSearch').value = '';
            populateFilterOptions();
            applyFilters();
        }

        // --- RENDER TABLE ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(filteredDB.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            }
            document.getElementById('empty-state').style.display = 'none';

            filteredDB.forEach(c => {
                let badge = 'badge-as';
                if(c.region === 'North America') badge = 'badge-na';
                if(c.region === 'Europe') badge = 'badge-eu';

                const tr = document.createElement('tr');
                tr.onclick = () => showDetails(c.id);
                tr.innerHTML = `
                    <td onclick="event.stopPropagation()" style="text-align:center;">
                        <input type="checkbox" class="row-cb" value="${c.id}" onchange="toggleSelect('${c.id}')" ${selectedIDs.has(c.id)?'checked':''}>
                    </td>
                    <td style="color:var(--text-light); font-family:monospace;">${c.id}</td>
                    <td style="font-weight:600; color:var(--primary);">${c.name}</td>
                    <td><span class="badge ${badge}">${c.region}</span></td>
                    <td style="color:var(--accent); font-weight:500;">${c.coreProduct || '-'}</td>
                    <td>${c.industry}</td>
                    <td>${c.employees.toLocaleString()}</td>
                    <td>$${c.revenue.toLocaleString()}M</td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn btn-outline" style="padding:4px 10px; font-size:11px;" onclick="showDetails('${c.id}')">View</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            checkSelectAllBox();
        }

        // --- ANALYTICS ---
        function renderAnalytics() {
            const getTop = (key, formatCb, isStat=false) => {
                const sorted = [...filteredDB].sort((a,b) => {
                    let valA = isStat ? (a.stats[key] || 0) : (a[key] || 0);
                    let valB = isStat ? (b.stats[key] || 0) : (b[key] || 0);
                    return valB - valA;
                });
                
                let topVal = 0;
                let topName = '-';
                
                if(sorted.length > 0) {
                    topVal = isStat ? (sorted[0].stats[key] || 0) : (sorted[0][key] || 0);
                    if(topVal > 0) topName = sorted[0].name;
                }

                return { name: topName, val: formatCb ? formatCb(topVal) : topVal };
            };

            const topRev = getTop('revenue', v => `$${v.toLocaleString()}M`);
            document.getElementById('tp-rev').innerText = topRev.name;
            document.getElementById('tp-rev-val').innerText = topRev.val;

            const topEmp = getTop('employees', v => `${v.toLocaleString()} emp`);
            document.getElementById('tp-emp').innerText = topEmp.name;
            document.getElementById('tp-emp-val').innerText = topEmp.val;

            const topDist = getTop('distributors', v => `${v} dist`, true);
            document.getElementById('tp-dist').innerText = topDist.name;
            document.getElementById('tp-dist-val').innerText = topDist.val;

            const topExp = getTop('experience', v => `${v} years`, true);
            document.getElementById('tp-exp').innerText = topExp.name;
            document.getElementById('tp-exp-val').innerText = topExp.val;

            const topWare = getTop('warehouses', v => `${v} sites`, true);
            document.getElementById('tp-ware').innerText = topWare.name;
            document.getElementById('tp-ware-val').innerText = topWare.val;

            renderCharts();
        }

        function renderCharts() {
            const chartColors = [
                getComputedStyle(document.documentElement).getPropertyValue('--chart-1'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-2'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-3'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-4'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-5'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-6'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-7'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-8'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-9'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-10'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-11'),
            ];

            // Revenue Share
            const ctxRev = document.getElementById('chartRevenue');
            const top5Rev = [...filteredDB].sort((a,b) => b.revenue - a.revenue).slice(0, 5);
            if(charts.rev) charts.rev.destroy();
            charts.rev = new Chart(ctxRev, {
                type: 'doughnut',
                data: {
                    labels: top5Rev.map(c => c.name),
                    datasets: [{ data: top5Rev.map(c => c.revenue), backgroundColor: chartColors.slice(0, top5Rev.length) }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position:'right' } } }
            });

            // Regional Distribution
            const ctxReg = document.getElementById('chartRegion');
            const regCounts = {};
            filteredDB.forEach(c => regCounts[c.region] = (regCounts[c.region]||0)+1);
            if(charts.reg) charts.reg.destroy();
            charts.reg = new Chart(ctxReg, {
                type: 'bar',
                data: {
                    labels: Object.keys(regCounts),
                    datasets: [{ label: 'Companies', data: Object.values(regCounts), backgroundColor: chartColors.slice(0, Object.keys(regCounts).length) }]
                },
                options: { maintainAspectRatio: false }
            });

            // Employee Count Distribution
            const ctxEmp = document.getElementById('chartEmployees');
            const empCounts = {};
            const maxEmp = Math.max(...filteredDB.map(c => c.employees)) || 1000;
            const buckets = [0, 100, 500, 1000, 5000, 10000, maxEmp > 10000 ? maxEmp : 10000]; // Example buckets
            filteredDB.forEach(c => {
                let bucketIndex = buckets.findIndex(b => c.employees < b);
                if(bucketIndex === -1) bucketIndex = buckets.length - 1;
                const label = bucketIndex === 0 ? '<100' : `${buckets[bucketIndex-1]}-${buckets[bucketIndex]}`;
                empCounts[label] = (empCounts[label] || 0) + 1;
            });
            if(charts.emp) charts.emp.destroy();
            charts.emp = new Chart(ctxEmp, {
                type: 'bar',
                data: {
                    labels: Object.keys(empCounts).sort(),
                    datasets: [{ label: 'Companies', data: Object.values(empCounts), backgroundColor: chartColors.slice(0, Object.keys(empCounts).length) }]
                },
                options: { maintainAspectRatio: false }
            });
            
            // Distributor Count Distribution
            const ctxDist = document.getElementById('chartDistributors');
            const distCounts = {};
            const maxDist = Math.max(...filteredDB.map(c => c.stats.distributors)) || 100;
            const distBuckets = [0, 10, 50, 100, 500, maxDist > 500 ? maxDist : 500];
            filteredDB.forEach(c => {
                let bucketIndex = distBuckets.findIndex(b => c.stats.distributors < b);
                if(bucketIndex === -1) bucketIndex = distBuckets.length - 1;
                const label = bucketIndex === 0 ? '<10' : `${distBuckets[bucketIndex-1]}-${distBuckets[bucketIndex]}`;
                distCounts[label] = (distCounts[label] || 0) + 1;
            });
            if(charts.dist) charts.dist.destroy();
            charts.dist = new Chart(ctxDist, {
                type: 'bar',
                data: {
                    labels: Object.keys(distCounts).sort(),
                    datasets: [{ label: 'Companies', data: Object.values(distCounts), backgroundColor: chartColors.slice(0, Object.keys(distCounts).length) }]
                },
                options: { maintainAspectRatio: false }
            });

            // Warehouse Count Distribution
            const ctxWare = document.getElementById('chartWarehouses');
            const wareCounts = {};
            const maxWare = Math.max(...filteredDB.map(c => c.stats.warehouses)) || 50;
            const wareBuckets = [0, 5, 10, 25, 50, maxWare > 50 ? maxWare : 50];
            filteredDB.forEach(c => {
                let bucketIndex = wareBuckets.findIndex(b => c.stats.warehouses < b);
                if(bucketIndex === -1) bucketIndex = wareBuckets.length - 1;
                const label = bucketIndex === 0 ? '<5' : `${wareBuckets[bucketIndex-1]}-${wareBuckets[bucketIndex]}`;
                wareCounts[label] = (wareCounts[label] || 0) + 1;
            });
            if(charts.ware) charts.ware.destroy();
            charts.ware = new Chart(ctxWare, {
                type: 'bar',
                data: {
                    labels: Object.keys(wareCounts).sort(),
                    datasets: [{ label: 'Companies', data: Object.values(wareCounts), backgroundColor: chartColors.slice(0, Object.keys(wareCounts).length) }]
                },
                options: { maintainAspectRatio: false }
            });
            
            // Core Products
            const ctxCore = document.getElementById('chartCoreProducts');
            const coreProdCounts = {};
            const rawProds = filteredDB.map(x => x.coreProduct).filter(Boolean);
            const splitProds = rawProds.flatMap(p => p.split(',').map(s => s.trim()));
            splitProds.forEach(p => coreProdCounts[p] = (coreProdCounts[p]||0) + 1);
            if(charts.core) charts.core.destroy();
            charts.core = new Chart(ctxCore, {
                type: 'bar',
                data: {
                    labels: Object.keys(coreProdCounts).sort(),
                    datasets: [{ label: 'Companies', data: Object.values(coreProdCounts), backgroundColor: chartColors.slice(0, Object.keys(coreProdCounts).length) }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        // --- COMPARISON LOGIC ---
        function getCatIcon(cat) {
            const c = cat.toLowerCase();
            let color = '#64748b';
            let icon = 'fa-circle';
            
            if(c.includes('swot')) { icon = 'fa-shield-halved'; color = '#8b5cf6'; }
            else if(c.includes('finance') || c.includes('revenue')) { icon = 'fa-coins'; color = '#eab308'; }
            else if(c.includes('hr') || c.includes('employ')) { icon = 'fa-users'; color = '#ec4899'; }
            else if(c.includes('product') || c.includes('core')) { icon = 'fa-box-open'; color = '#3b82f6'; }
            else if(c.includes('general') || c.includes('overview')) { icon = 'fa-info-circle'; color = '#0f172a'; }
            else if(c.includes('parent')) { icon = 'fa-sitemap'; color = '#f97316'; }
            else if(c.includes('legal') || c.includes('structure')) { icon = 'fa-scale-balanced'; color = '#14b8a6'; }
            else { icon = 'fa-layer-group'; color = '#64748b'; }

            return `<div class="dp-icon" style="background:${color}20; color:${color}"><i class="fa-solid ${icon}"></i></div>`;
        }

        function openCompareView() {
            if(selectedIDs.size < 1) return alert("Select at least 1 company.");
            
            const comps = db.filter(c => selectedIDs.has(c.id));
            const table = document.getElementById('compTable');
            
            const keyMap = {}; 
            comps.forEach(c => {
                c.data.forEach(d => {
                    if(!keyMap[d.cat]) keyMap[d.cat] = new Set();
                    keyMap[d.cat].add(d.key);
                });
            });

            let html = `<thead><tr><th style="left:0; z-index:20; min-width:200px;">Data Point</th>`;
            comps.forEach(c => {
                html += `<th>
                    <div class="comp-header-content">
                        <span class="comp-name" title="${c.name}">${c.name}</span>
                        <button class="remove-col-btn" onclick="removeFromCompare('${c.id}')"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </th>`;
            });
            html += `</tr></thead><tbody>`;

            html += `<tr class="comp-cat-row"><td colspan="${comps.length+1}">${getCatIcon('General')} Overview</td></tr>`;
            html += `<tr><td><b>Core Product</b></td>${comps.map(c=>`<td>${c.coreProduct}</td>`).join('')}</tr>`;
            html += `<tr><td><b>Region</b></td>${comps.map(c=>`<td>${c.region}</td>`).join('')}</tr>`;
            html += `<tr><td><b>Revenue</b></td>${comps.map(c=>`<td>$${c.revenue.toLocaleString()}M</td>`).join('')}</tr>`;
            html += `<tr><td><b>Employees</b></td>${comps.map(c=>`<td>${c.employees.toLocaleString()}</td>`).join('')}</tr>`;

            for(const [cat, keys] of Object.entries(keyMap)) {
                html += `<tr class="comp-cat-row"><td colspan="${comps.length+1}">${getCatIcon(cat)} ${cat}</td></tr>`;
                keys.forEach(k => {
                    let rowClass = "";
                    const kl = k.toLowerCase();
                    if(cat === 'SWOT') {
                        if(kl.includes('strength')) rowClass = 'swot-s';
                        else if(kl.includes('weakness')) rowClass = 'swot-w';
                        else if(kl.includes('opportun')) rowClass = 'swot-o';
                        else if(kl.includes('threat')) rowClass = 'swot-t';
                    }
                    
                    html += `<tr><td class="${rowClass}"><b>${k}</b></td>`;
                    comps.forEach(c => {
                        const dp = c.data.find(d => d.cat === cat && d.key === k);
                        html += `<td class="${rowClass}">${dp ? dp.val : '-'}</td>`;
                    });
                    html += `</tr>`;
                });
            }

            table.innerHTML = html + "</tbody>";
            document.getElementById('compareView').classList.add('open');
        }

        function removeFromCompare(id) {
            toggleSelect(id);
            if(selectedIDs.size < 1) {
                document.getElementById('compareView').classList.remove('open');
            } else {
                openCompareView(); 
            }
        }

        // --- CHATBOT ---
        function toggleChat() {
            const win = document.getElementById('chatWindow');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleChatEnter(e) { if(e.key === 'Enter') handleChat(); }

        function handleChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;

            addMsg(msg, 'user');
            input.value = '';
            chatHistory.push({ role: 'user', content: msg });

            // Simulate AI Response
            setTimeout(() => {
                let response = "I'm not sure about that specific detail. Try asking about revenue, employees, or listing companies.";
                const lcMsg = msg.toLowerCase();

                if(lcMsg.includes('hello') || lcMsg.includes('hi')) {
                    response = "Hello! How can I help you analyze your competitor data today?";
                } else if(lcMsg.includes('how many') && lcMsg.includes('company')) {
                    response = `There are ${db.length} companies currently in the database.`;
                } else if((lcMsg.includes('highest') || lcMsg.includes('most') || lcMsg.includes('top')) && lcMsg.includes('revenue')) {
                    const top = [...db].sort((a,b)=>b.revenue - a.revenue)[0];
                    response = `The company with the highest revenue is ${top.name} with $${top.revenue}M.`;
                } else if((lcMsg.includes('most') || lcMsg.includes('highest') || lcMsg.includes('largest')) && (lcMsg.includes('employee') || lcMsg.includes('staff'))) {
                    const top = [...db].sort((a,b)=>b.employees - a.employees)[0];
                    response = `${top.name} has the most employees (${top.employees.toLocaleString()}).`;
                } else if(lcMsg.includes('list') || lcMsg.includes('show me')) {
                    const names = db.slice(0, 5).map(c=>c.name).join(', ');
                    response = `Here are a few companies: ${names}...`;
                } else {
                    // Try to find company summary
                    const companyMatch = db.find(c => msg.toLowerCase().includes(c.name.toLowerCase()));
                    if(companyMatch) {
                        response = `${companyMatch.name} is located in ${companyMatch.region}. They have ${companyMatch.employees.toLocaleString()} employees and approx $${companyMatch.revenue}M in revenue.`;
                        // Add more details if needed, e.g., core product
                        if (companyMatch.coreProduct && companyMatch.coreProduct !== '-') {
                            response += ` Their core product is ${companyMatch.coreProduct}.`;
                        }
                    } else if (lcMsg.includes('what is the top')) {
                        // General top item extraction
                        let topItem = 'Nothing found';
                        let maxVal = 0;
                        let itemType = '';

                        if (lcMsg.includes('distributor')) { itemType = 'distributors'; maxVal = Math.max(...db.map(c=>c.stats.distributors)); topItem = db.find(c=>c.stats.distributors === maxVal).name; }
                        else if (lcMsg.includes('warehouse')) { itemType = 'warehouses'; maxVal = Math.max(...db.map(c=>c.stats.warehouses)); topItem = db.find(c=>c.stats.warehouses === maxVal).name; }
                        else if (lcMsg.includes('experience') || lcMsg.includes('oldest')) { itemType = 'experience'; maxVal = Math.max(...db.map(c=>c.stats.experience)); topItem = db.find(c=>c.stats.experience === maxVal).name; }

                        if (topItem !== '-') {
                            response = `The company with the most ${itemType} is ${topItem} (${maxVal}).`;
                        }
                    }
                }
                addMsg(response, 'bot');
            }, 600);
        }

        function addMsg(text, type) {
            const body = document.getElementById('chatBody');
            const div = document.createElement('div');
            div.className = `msg msg-${type}`;
            div.innerText = text;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        // --- ADD COMPANIES MODAL ---
        function openAddModal() {
            document.getElementById('addModal').style.display = 'flex';
            renderAddList();
        }

        function renderAddList() {
            const q = document.getElementById('addSearch').value.toLowerCase();
            const list = document.getElementById('add-list');
            list.innerHTML = '';
            
            const available = db.filter(c => !selectedIDs.has(c.id) && (c.name.toLowerCase().includes(q) || c.id.toLowerCase().includes(q)));
            
            if(available.length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#999;">No companies found.</div>';
                return;
            }

            available.forEach(c => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.borderBottom = '1px solid #eee';
                div.style.cursor = 'pointer';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.innerHTML = `<span>${c.name}</span> <span style="font-size:11px; color:#666;">${c.id}</span>`;
                div.onmouseover = () => div.style.background = '#f8fafc';
                div.onmouseout = () => div.style.background = 'white';
                div.onclick = () => {
                    toggleSelect(c.id, true);
                    openCompareView(); 
                    renderAddList(); 
                };
                list.appendChild(div);
            });
        }

        // --- EXPORT ---
        function initDownload(type) {
            if(selectedIDs.size === 0) return alert("No companies selected.");
            currentDlType = type;
            document.getElementById('dlModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('dlModal').style.display = 'none'; }

        function executeDownload(format) {
            closeModal();
            const targets = db.filter(c => selectedIDs.has(c.id));
            
            if(format === 'pdf') {
                if(targets.length > 5) return alert("PDF export limited to 5 companies.");
                generatePDF(targets);
            } else {
                generateExcel(targets);
            }
        }

        function generateExcel(data) {
            const wb = XLSX.utils.book_new();
            const summaryData = data.map(c => ({
                "ID": c.id, "Name": c.name, "Region": c.region, "Core Product": c.coreProduct, 
                "Industry": c.industry, "Revenue": c.revenue, "Employees": c.employees
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryData), "Summary");

            const flatData = data.map(c => {
                const flat = { "ID": c.id, "Name": c.name };
                c.data.forEach(d => flat[`${d.cat} - ${d.key}`] = d.val);
                return flat;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(flatData), "Detailed Data");
            XLSX.writeFile(wb, "CompeteBase_Export.xlsx");
        }

        function generatePDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Competitor Analysis Report", 14, 20);
            data.forEach((c, index) => {
                if(index > 0) doc.addPage();
                doc.setFontSize(14);
                doc.setTextColor(37, 99, 235);
                doc.text(`${c.name} (${c.id})`, 14, 30);
                doc.setTextColor(0);
                doc.setFontSize(10);
                doc.text(`Region: ${c.region} | Core: ${c.coreProduct} | Rev: $${c.revenue}M`, 14, 36);
                doc.autoTable({
                    startY: 40,
                    head: [['Category', 'Metric', 'Value']],
                    body: c.data.map(d => [d.cat, d.key, d.val]),
                    theme: 'grid'
                });
            });
            doc.save("Competitor_Report.pdf");
        }

        // --- SETTINGS ---
        function renderSettings() {
            const q = document.getElementById('deleteSearch').value.toLowerCase();
            const list = document.getElementById('delete-list');
            list.innerHTML = '';

            const matches = db.filter(c => c.name.toLowerCase().includes(q) || c.id.toLowerCase().includes(q));
            
            if(matches.length === 0) {
                list.innerHTML = "<div style='padding:10px; color:#888;'>No matches found.</div>";
                return;
            }

            matches.forEach(m => {
                const div = document.createElement('div');
                div.style.padding = "10px";
                div.style.borderBottom = "1px solid #eee";
                div.style.display = "flex";
                div.style.justifyContent = "space-between";
                div.style.alignItems = "center";
                div.innerHTML = `<span><b>${m.name}</b> (${m.id})</span>`;
                
                const btn = document.createElement('button');
                btn.className = 'btn btn-danger';
                btn.style.padding = '4px 8px';
                btn.style.fontSize = '11px';
                btn.innerText = 'Delete';
                btn.onclick = () => deleteCompany(m.id);
                
                div.appendChild(btn);
                list.appendChild(div);
            });
        }

        function deleteCompany(id) {
            if(!confirm("Are you sure? This cannot be undone.")) return;
            db = db.filter(c => c.id !== id);
            saveDB();
            location.reload(); 
        }

        // --- UTILS ---
        function toggleSelectAll(source) {
            document.querySelectorAll('.row-cb').forEach(cb => {
                cb.checked = source.checked;
                toggleSelect(cb.value, false);
            });
            updateFab();
        }

        function toggleSelect(id, updateUI=true) {
            if(selectedIDs.has(id)) selectedIDs.delete(id);
            else selectedIDs.add(id);
            if(updateUI) updateFab();
        }

        function checkSelectAllBox() {
            const all = filteredDB.length > 0 && filteredDB.every(c => selectedIDs.has(c.id));
            document.getElementById('selectAllBox').checked = all;
        }

        function updateFab() {
            document.getElementById('compCount').innerText = selectedIDs.size;
            document.getElementById('compareFab').style.display = selectedIDs.size > 0 ? 'flex' : 'none';
        }

        function showDetails(id) {
            const c = db.find(x => x.id === id);
            if(!c) return;
            document.getElementById('d-name').innerText = c.name;
            const con = document.getElementById('d-content');
            
            const groups = {};
            c.data.forEach(d => {
                if(!groups[d.cat]) groups[d.cat] = [];
                groups[d.cat].push(d);
            });

            let html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div class="player-card"><b>ID:</b> ${c.id}</div>
                <div class="player-card"><b>Region:</b> ${c.region}</div>
                <div class="player-card"><b>Core:</b> ${c.coreProduct}</div>
                <div class="player-card"><b>Revenue:</b> $${c.revenue}M</div>
            </div>`;

            for(const [cat, items] of Object.entries(groups)) {
                html += `<div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:5px; color:var(--text-light); text-transform:uppercase; font-size:12px; display:flex; align-items:center;">
                        ${getCatIcon(cat)} ${cat}
                    </h4>`;
                items.forEach(i => {
                    let valClass = "";
                    if(cat === 'SWOT') {
                        if(i.key.includes('Strength')) valClass = "swot-s";
                        if(i.key.includes('Weakness')) valClass = "swot-w";
                    }
                    html += `<div style="display:flex; justify-content:space-between; font-size:13px; padding:6px 0; border-bottom:1px solid #f1f5f9;">
                        <span style="font-weight:500;">${i.key}</span>
                        <span class="${valClass}" style="max-width:50%; text-align:right; ${valClass?'padding:2px 6px; border-radius:4px;':''}">${i.val}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            con.innerHTML = html;
            document.getElementById('drawerOverlay').style.display = 'block';
            setTimeout(() => document.getElementById('detailsDrawer').classList.add('open'), 10);
        }

        function closeDrawer() {
            document.getElementById('detailsDrawer').classList.remove('open');
            setTimeout(() => document.getElementById('drawerOverlay').style.display = 'none', 300);
        }

        function switchView(view) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active'); 
            document.getElementById(view).classList.add('active');
            if(view === 'analytics') renderAnalytics();
            if(view === 'list') renderTable();
        }

        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        
        function strHash(s) { let h=0; for(let i=0;i<s.length;i++) h = Math.imul(31,h)+s.charCodeAt(i)|0; return h; }
        function parseMoney(s) { const m = s.match(/(\d+(\.\d+)?)/); return m ? parseFloat(m[0]) : 0; }
        function parseNum(s) { return parseInt(s.replace(/,/g,'').replace(/\D/g, '')) || 0; }
        function extractNum(val) {
            if(!val) return 0;
            const match = String(val).replace(/,/g,'').match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }

    </script>
</body>
</html>