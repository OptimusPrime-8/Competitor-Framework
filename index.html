<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompeteBase Pro - Market Intelligence</title>
    
    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* PALETTE */
            --primary: #0f172a; --secondary: #334155; --accent: #2563eb; --accent-hover: #1d4ed8;
            --bg: #f1f5f9; --surface: #ffffff; --border: #e2e8f0; --text-main: #1e293b;
            --text-light: #64748b; --danger: #ef4444; --danger-bg: #fef2f2;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- NAVBAR --- */
        .navbar { height: 64px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; gap: 20px; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; white-space: nowrap; text-decoration: none; }
        
        .search-wrapper { flex: 1; max-width: 500px; position: relative; }
        .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .search-input { width: 100%; padding: 10px 10px 10px 36px; border-radius: 8px; border: 1px solid var(--border); background: #f8fafc; outline: none; transition: 0.2s; font-size: 14px; }
        .search-input:focus { background: white; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        .tabs { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 8px; margin-left: 20px; }
        .tab { padding: 6px 16px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; user-select: none; }
        .tab.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .nav-actions { display: flex; gap: 10px; margin-left: auto; }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: var(--accent-hover); }
        .btn-outline { border-color: var(--border); background: white; color: var(--text-main); }
        .btn-outline:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-danger { background: var(--danger-bg); color: var(--danger); border-color: #fecaca; }

        /* --- LAYOUT --- */
        .layout { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR (Updated with Footer) */
        .sidebar { width: 260px; background: var(--primary); color: #94a3b8; display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
        .sidebar-scroll { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .sidebar-header { padding: 24px 20px 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #64748b; border-bottom: 1px solid #1e293b; margin-bottom: 10px; }
        .nav-item { padding: 12px 24px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 13px; transition: 0.2s; border-left: 3px solid transparent; color: #cbd5e1; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: white; border-left-color: var(--accent); }
        .nav-item .count { margin-left: auto; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 10px; }
        
        /* SIDEBAR SETTINGS FOOTER */
        .sidebar-footer { padding: 15px; border-top: 1px solid #1e293b; background: #0f172a; }
        .settings-btn { display: flex; align-items: center; gap: 10px; color: #cbd5e1; padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; width: 100%; font-size: 13px; font-weight: 600; }
        .settings-btn:hover, .settings-btn.active { background: #334155; color: white; }

        /* MAIN AREA */
        .main { flex: 1; padding: 24px; overflow-y: auto; background: var(--bg); position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD --- */
        .toolbar { display: flex; gap: 15px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); align-items: center; }
        .filter-select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 13px; color: var(--text-main); outline: none; }
        
        .table-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 16px 20px; font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; color: var(--accent); }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        tr:hover { background: #f8fafc; cursor: pointer; }
        
        .company-cell { display: flex; align-items: center; gap: 12px; font-weight: 600; color: var(--primary); }
        .avatar { width: 36px; height: 36px; background: #e0e7ff; color: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-na { background: #dbeafe; color: #1e40af; } 
        .badge-eu { background: #dcfce7; color: #166534; } 
        .badge-as { background: #fef9c3; color: #854d0e; }
        .badge-unknown { background: #f1f5f9; color: #64748b; }

        /* --- ANALYTICS --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: white; padding: 24px; border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .kpi-value { font-size: 28px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .kpi-label { font-size: 13px; color: var(--text-light); font-weight: 500; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; }
        .chart-box { background: white; padding: 24px; border-radius: 10px; border: 1px solid var(--border); height: 400px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .chart-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* --- SETTINGS --- */
        .settings-container { max-width: 800px; margin: 0 auto; }
        .settings-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .settings-header { font-size: 16px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .settings-info { font-size: 14px; color: var(--text-light); }
        .export-options { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .export-card { border: 2px solid var(--border); border-radius: 8px; padding: 20px; width: 150px; text-align: center; cursor: pointer; transition: 0.2s; }
        .export-card:hover { border-color: var(--accent); background: #eff6ff; }
        .export-card i { font-size: 30px; margin-bottom: 10px; color: var(--secondary); }

        /* --- DETAILS DRAWER --- */
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; display: none; backdrop-filter: blur(2px); }
        .drawer { position: fixed; top: 0; right: -650px; width: 600px; bottom: 0; background: white; z-index: 100; transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; box-shadow: -10px 0 25px rgba(0,0,0,0.1); }
        .drawer.open { right: 0; }
        .drawer-header { padding: 24px; border-bottom: 1px solid var(--border); background: #fff; display: flex; justify-content: space-between; align-items: start; }
        .drawer-content { flex: 1; overflow-y: auto; padding: 24px; background: #f8fafc; }
        .detail-section { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .detail-title { color: var(--accent); font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; letter-spacing: 0.5px; }
        .detail-row { display: grid; grid-template-columns: 140px 1fr; gap: 15px; margin-bottom: 12px; font-size: 14px; }
        .detail-label { color: var(--text-light); font-weight: 500; }
        .detail-value { color: var(--text-main); font-weight: 500; line-height: 1.5; }

        /* --- FULL SCREEN COMPARISON --- */
        .modal-fullscreen { position: fixed; inset: 0; background: #f8fafc; z-index: 200; display: none; flex-direction: column; }
        .modal-fullscreen.open { display: flex; }
        
        .comp-header { height: 70px; background: white; border-bottom: 1px solid var(--border); padding: 0 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); z-index: 20; }
        .comp-body { flex: 1; overflow: auto; padding: 30px; }
        
        .comp-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        .comp-table th { background: white; position: sticky; top: 0; padding: 20px; border-bottom: 3px solid var(--accent); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.05); min-width: 200px; text-align: left; }
        .comp-table td { background: white; border: 1px solid var(--border); padding: 15px; vertical-align: top; font-size: 14px; }
        .comp-header-row { background: #f1f5f9; font-weight: 800; color: var(--primary); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; padding-left: 20px; }

        /* --- MODAL (Small) --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 100%; max-width: 500px; border-radius: 12px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        /* --- FAB --- */
        .fab { position: fixed; bottom: 40px; right: 40px; background: var(--accent); color: white; padding: 14px 28px; border-radius: 50px; font-weight: 600; box-shadow: 0 10px 20px rgba(37,99,235,0.3); cursor: pointer; display: none; align-items: center; gap: 10px; z-index: 80; transition: transform 0.2s; }
        .fab:hover { transform: translateY(-3px); background: var(--accent-hover); }

        #fileInput { display: none; }
        .empty-state { text-align: center; padding: 100px 20px; color: var(--text-light); }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <a href="#" class="logo"><i class="fa-solid fa-chart-radar"></i> CompeteBase <span>PRO</span></a>
        
        <div class="search-wrapper">
            <i class="fa-solid fa-search"></i>
            <input type="text" class="search-input" id="globalSearch" placeholder="Search companies..." onkeyup="handleSearch()">
        </div>

        <div class="tabs">
            <div class="tab active" id="tab-list" onclick="switchView('list')">Dashboard</div>
            <div class="tab" id="tab-analytics" onclick="switchView('analytics')">Analytics</div>
        </div>

        <div class="nav-actions">
            <button class="btn btn-accent" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up"></i> Upload Excel
            </button>
            <input type="file" id="fileInput" accept=".xlsx" onchange="processExcel(this)">
        </div>
    </div>

    <div class="layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-scroll">
                <div class="sidebar-header">Category Filter</div>
                <div class="nav-item active" onclick="filterData('category', 'All', this)">
                    <i class="fa-solid fa-layer-group"></i> All Categories
                </div>
                <div id="category-list"></div>
            </div>
            
            <!-- SETTINGS AT BOTTOM -->
            <div class="sidebar-footer">
                <div class="settings-btn" id="btn-settings" onclick="switchView('settings')">
                    <i class="fa-solid fa-gear"></i> Settings / Data
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            
            <!-- VIEW 1: DASHBOARD (Default) -->
            <div id="list" class="view-section active">
                <div class="toolbar">
                    <span style="font-size:12px; font-weight:600; color:var(--text-light);">Filter Region:</span>
                    <select id="regionFilter" class="filter-select" onchange="applyToolbarFilters()">
                        <option value="All">All Regions</option>
                        <option value="North America">North America</option>
                        <option value="Europe">Europe</option>
                        <option value="Asia">Asia</option>
                    </select>
                </div>

                <div class="table-card">
                    <table>
                        <thead>
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAllBox" onchange="toggleSelectAll(this)" style="cursor:pointer;" title="Select All"></th>
                                <th width="30%" onclick="sortTable('name')">Company Name <i class="fa-solid fa-sort"></i></th>
                                <th width="15%" onclick="sortTable('region')">Region <i class="fa-solid fa-sort"></i></th>
                                <th width="20%">Industry</th>
                                <th width="15%" onclick="sortTable('revenue')">Revenue <i class="fa-solid fa-sort"></i></th>
                                <th width="10%">Details</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                    <div id="empty-state" class="empty-state">
                        <i class="fa-solid fa-folder-open" style="font-size:48px; margin-bottom:15px; opacity:0.3;"></i>
                        <h3>No Data Found</h3>
                        <p>Upload your Excel file to populate the dashboard.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ANALYTICS -->
            <div id="analytics" class="view-section">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-companies">0</div>
                        <div class="kpi-label">Active Competitors</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-revenue">$0M</div>
                        <div class="kpi-label">Total Market Revenue (Est)</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-rating">0.0</div>
                        <div class="kpi-label">Avg Market Rating</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-products">0</div>
                        <div class="kpi-label">Total Data Points</div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-box"><div class="chart-title">Revenue Share</div><canvas id="revChart"></canvas></div>
                    <div class="chart-box"><div class="chart-title">Geographic Presence</div><canvas id="geoChart"></canvas></div>
                </div>
            </div>

            <!-- VIEW 3: SETTINGS -->
            <div id="settings" class="view-section">
                <div class="settings-container">
                    <div class="settings-card" style="border-left: 5px solid var(--danger);">
                        <div class="settings-header" style="color:var(--danger);">
                            <i class="fa-solid fa-triangle-exclamation"></i> Danger Zone
                        </div>
                        <div class="settings-row">
                            <span class="settings-info">Permanently delete all imported competitor data?</span>
                            <button class="btn btn-danger" onclick="resetData()">
                                <i class="fa-solid fa-trash"></i> Reset All Data
                            </button>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-header" style="color:var(--primary);">
                            <i class="fa-solid fa-file-export"></i> Global Data Export
                        </div>
                        <p style="font-size:14px; color:var(--text-light); margin-bottom:20px;">
                            Download the <b>Entire Database</b> (All uploaded files merged) as a JSON backup.
                        </p>
                        <div class="settings-row">
                            <span class="settings-info">Export all data (JSON)</span>
                            <button class="btn btn-outline" onclick="exportGlobalData()">
                                <i class="fa-solid fa-download"></i> Download Full DB
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- DETAILS DRAWER -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="detailsDrawer">
        <div class="drawer-header">
            <div>
                <h2 style="margin:0; font-size:20px; color:var(--primary);" id="d-name">Company Name</h2>
                <div style="font-size:13px; color:var(--text-light); margin-top:4px;" id="d-meta">ID: 12345</div>
            </div>
            <button onclick="closeDrawer()" class="btn btn-outline" style="border:none; font-size:20px;">&times;</button>
        </div>
        <div class="drawer-content" id="d-content"></div>
    </div>

    <!-- GLOBAL EXPORT MODAL -->
    <div class="modal" id="exportModal">
        <div class="modal-box">
            <div class="modal-head">
                <h2 style="color:var(--primary); margin:0;">Export Options</h2>
                <button class="btn btn-outline" onclick="closeModal('exportModal')" style="border:none;">&times;</button>
            </div>
            <div class="export-options">
                <div class="export-card" onclick="downloadExcel()">
                    <i class="fa-regular fa-file-excel"></i>
                    <div>Excel (.xlsx)</div>
                </div>
                <div class="export-card" onclick="downloadPDF()">
                    <i class="fa-regular fa-file-pdf"></i>
                    <div>PDF Report</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FULL SCREEN COMPARISON VIEW -->
    <div class="modal-fullscreen" id="compareView">
        <div class="comp-header">
            <h2 style="color:var(--primary); margin:0; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-scale-balanced" style="color:var(--accent);"></i> Head-to-Head Comparison
            </h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="exportComparison()">
                    <i class="fa-solid fa-file-csv"></i> Export This View
                </button>
                <button class="btn btn-primary" onclick="closeCompare()">
                    <i class="fa-solid fa-xmark"></i> Close View
                </button>
            </div>
        </div>
        <div class="comp-body">
            <table class="comp-table" id="compTable"></table>
        </div>
    </div>

    <!-- FLOATING COMPARE BTN -->
    <div class="fab" id="compareFab" onclick="openCompare()">
        <i class="fa-solid fa-scale-balanced"></i> Compare (<span id="compCount">0</span>)
    </div>

    <script>
        // --- CONFIG ---
        const DB_KEY = 'competeBase_final_v4';
        const { jsPDF } = window.jspdf;
        let db = [];
        let filteredDB = [];
        let compareSet = new Set();
        let charts = {};
        let currentSort = { column: null, dir: 'asc' };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                db = JSON.parse(saved);
                filteredDB = [...db];
                updateUI();
            }
        });

        // --- EXCEL LOGIC ---
        function processExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (rows.length < 2) return alert("File Empty");

                const headers = rows[0];
                const newEntries = [];

                for (let c = 2; c < headers.length; c++) {
                    if (!headers[c]) continue;
                    let entry = {
                        id: Date.now() + Math.random(),
                        name: headers[c],
                        data: [],
                        smart: { region: 'Unknown', revenue: 0, revenueStr: '-', employees: 0, rating: 0, industry: 'N/A' }
                    };

                    for (let r = 1; r < rows.length; r++) {
                        const cat = rows[r][0] ? rows[r][0].trim() : "Other";
                        const key = rows[r][1] ? rows[r][1].trim() : "";
                        const val = rows[r][c] ? String(rows[r][c]).trim() : "-";
                        
                        if (key) {
                            entry.data.push({ cat, key, val });
                            const k = key.toLowerCase(), v = val.toLowerCase();

                            if (k === 'company name') entry.name = val;
                            if (k.includes('headquarters') || k.includes('location')) {
                                if (v.includes('usa') || v.includes('united states')) entry.smart.region = 'North America';
                                else if (v.includes('china') || v.includes('asia')) entry.smart.region = 'Asia';
                                else if (v.includes('europe') || v.includes('uk') || v.includes('germany')) entry.smart.region = 'Europe';
                            }
                            if (k.includes('revenue')) {
                                entry.smart.revenueStr = val;
                                const nums = val.match(/(\d+)/g);
                                if (nums) entry.smart.revenue = nums.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / nums.length;
                            }
                            if (cat === 'Feedback' && val.includes('/')) entry.smart.rating = parseFloat(val.split('/')[0]);
                            if (k.includes('type of company') || k.includes('industry')) entry.smart.industry = val;
                        }
                    }
                    newEntries.push(entry);
                }

                db = [...newEntries, ...db];
                applyToolbarFilters(); 
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                switchView('list');
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        // --- FILTER & SORT ---
        function applyToolbarFilters() {
            const region = document.getElementById('regionFilter').value;
            const q = document.getElementById('globalSearch').value.toLowerCase();
            
            filteredDB = db.filter(c => {
                const matchRegion = region === 'All' || c.smart.region === region;
                const matchSearch = c.name.toLowerCase().includes(q) || c.data.some(d => d.val.toLowerCase().includes(q));
                return matchRegion && matchSearch;
            });
            if(currentSort.column) sortTable(currentSort.column, true);
            updateUI();
        }

        function filterData(type, val, el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(el) el.classList.add('active');

            if (val === 'All') filteredDB = [...db];
            else if (type === 'category') filteredDB = db.filter(c => c.data.some(d => d.cat === val));
            
            updateUI();
        }

        function sortTable(col, applyOnly = false) {
            if(!applyOnly) {
                if(currentSort.column === col) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                else currentSort = { column: col, dir: 'asc' };
            }
            filteredDB.sort((a, b) => {
                let valA, valB;
                if(col === 'name') { valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); }
                if(col === 'region') { valA = a.smart.region; valB = b.smart.region; }
                if(col === 'revenue') { valA = a.smart.revenue; valB = b.smart.revenue; }
                if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
                return 0;
            });
            renderTable();
        }

        function handleSearch() { applyToolbarFilters(); }

        // --- UI RENDER ---
        function updateUI() {
            renderSidebar();
            renderTable();
            renderKPIs();
            renderCharts();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if (filteredDB.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            }
            document.getElementById('empty-state').style.display = 'none';

            filteredDB.forEach(c => {
                let badgeClass = 'badge-unknown';
                if(c.smart.region === 'North America') badgeClass = 'badge-na';
                if(c.smart.region === 'Europe') badgeClass = 'badge-eu';
                if(c.smart.region === 'Asia') badgeClass = 'badge-as';

                const tr = document.createElement('tr');
                tr.onclick = () => viewDetails(c.id);
                tr.innerHTML = `
                    <td onclick="event.stopPropagation()" style="text-align:center;">
                        <input type="checkbox" class="comp-cb" value="${c.id}" onchange="toggleCompare('${c.id}')" ${compareSet.has(c.id.toString())?'checked':''}>
                    </td>
                    <td>
                        <div class="company-cell">
                            <div class="avatar">${c.name.charAt(0)}</div>
                            ${c.name}
                        </div>
                    </td>
                    <td><span class="badge ${badgeClass}">${c.smart.region}</span></td>
                    <td>${c.smart.industry.substring(0, 25)}</td>
                    <td><b>${c.smart.revenueStr}</b></td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn btn-outline" onclick="viewDetails('${c.id}')" style="padding:6px 12px; font-size:11px;">
                            <i class="fa-solid fa-eye"></i> View
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            const allChecked = filteredDB.length > 0 && filteredDB.every(c => compareSet.has(c.id.toString()));
            document.getElementById('selectAllBox').checked = allChecked;
        }

        function renderSidebar() {
            const cList = document.getElementById('category-list');
            const cats = [...new Set(db.flatMap(c => c.data.map(d => d.cat)))];
            cList.innerHTML = '';
            cats.sort().forEach(cat => {
                cList.innerHTML += `<div class="nav-item" onclick="filterData('category','${cat}',this)"><i class="fa-solid fa-folder"></i> ${cat}</div>`;
            });
        }

        // --- EXPORT LOGIC ---
        // 1. GLOBAL EXPORT (Settings) - Full JSON Database
        function exportGlobalData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "CompeteBase_Full_DB.json");
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        }

        // 2. COMPARISON EXPORT (Excel Matrix)
        function exportComparison() {
            const comps = db.filter(c => compareSet.has(c.id.toString()));
            if(comps.length < 1) return;

            const map = {};
            comps.forEach(c => c.data.forEach(d => { if(!map[d.cat]) map[d.cat] = new Set(); map[d.cat].add(d.key); }));

            // Build Matrix for Excel
            // Headers: [Category, Data Point, Comp 1, Comp 2...]
            const matrix = [];
            const headerRow = ["Category", "Data Point"];
            comps.forEach(c => headerRow.push(c.name));
            matrix.push(headerRow);

            for(const [cat, kSet] of Object.entries(map)) {
                kSet.forEach(k => {
                    const row = [cat, k];
                    comps.forEach(c => {
                        const dp = c.data.find(d => d.cat === cat && d.key === k);
                        row.push(dp ? dp.val : '-');
                    });
                    matrix.push(row);
                });
            }

            const ws = XLSX.utils.aoa_to_sheet(matrix);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Comparison View");
            XLSX.writeFile(wb, "Comparison_Matrix.xlsx");
        }

        // --- ACTIONS & DETAILS ---
        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.comp-cb');
            checkboxes.forEach(cb => {
                cb.checked = source.checked;
                const id = cb.value;
                if(source.checked) compareSet.add(id);
                else compareSet.delete(id);
            });
            updateFab();
        }

        function toggleCompare(id) {
            id = id.toString();
            if (compareSet.has(id)) compareSet.delete(id);
            else compareSet.add(id);
            updateFab();
            document.getElementById('selectAllBox').checked = false;
        }

        function updateFab() {
            const fab = document.getElementById('compareFab');
            document.getElementById('compCount').innerText = compareSet.size;
            fab.style.display = compareSet.size > 0 ? 'flex' : 'none';
        }

        function viewDetails(id) {
            const comp = db.find(c => c.id.toString() === id.toString());
            if(!comp) return;

            document.getElementById('d-name').innerText = comp.name;
            document.getElementById('d-meta').innerText = comp.smart.region + " | " + comp.smart.revenueStr;
            const content = document.getElementById('d-content');
            
            const groups = {};
            comp.data.forEach(d => { if(!groups[d.cat]) groups[d.cat] = []; groups[d.cat].push(d); });

            let html = '';
            for(const [cat, items] of Object.entries(groups)) {
                html += `<div class="detail-section"><div class="detail-title">${cat}</div>`;
                items.forEach(item => {
                    html += `<div class="detail-row"><div class="detail-label">${item.key}</div><div class="detail-value">${item.val}</div></div>`;
                });
                html += `</div>`;
            }
            content.innerHTML = html;
            document.getElementById('drawerOverlay').style.display = 'block';
            setTimeout(() => document.getElementById('detailsDrawer').classList.add('open'), 10);
        }

        function closeDrawer() {
            document.getElementById('detailsDrawer').classList.remove('open');
            setTimeout(() => document.getElementById('drawerOverlay').style.display = 'none', 300);
        }

        // --- FULL SCREEN COMPARISON ---
        function openCompare() {
            const comps = db.filter(c => compareSet.has(c.id.toString()));
            if(comps.length < 1) return;

            const map = {};
            comps.forEach(c => c.data.forEach(d => { if(!map[d.cat]) map[d.cat] = new Set(); map[d.cat].add(d.key); }));

            let html = `<thead><tr><th style="z-index:20; left:0; width:200px;">Data Point</th>`;
            comps.forEach(c => html += `<th>${c.name}</th>`);
            html += `</tr></thead><tbody>`;

            for(const [cat, kSet] of Object.entries(map)) {
                html += `<tr><td colspan="${comps.length+1}" class="comp-header-row">${cat}</td></tr>`;
                kSet.forEach(k => {
                    html += `<tr><td style="font-weight:600; color:var(--text-light);">${k}</td>`;
                    comps.forEach(c => { const dp = c.data.find(d => d.cat === cat && d.key === k); html += `<td>${dp ? dp.val : '-'}</td>`; });
                    html += `</tr>`;
                });
            }
            document.getElementById('compTable').innerHTML = html;
            document.getElementById('compareView').classList.add('open');
        }

        function closeCompare() { document.getElementById('compareView').classList.remove('open'); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- ANALYTICS ---
        function renderKPIs() {
            document.getElementById('kpi-companies').innerText = filteredDB.length;
            const rev = filteredDB.reduce((a,b) => a+b.smart.revenue,0);
            document.getElementById('kpi-revenue').innerText = `$${rev.toLocaleString()}M`;
            document.getElementById('kpi-products').innerText = filteredDB.reduce((a,b) => a+b.data.length,0).toLocaleString();
            const rated = filteredDB.filter(c => c.smart.rating > 0);
            const avg = rated.length ? (rated.reduce((a,b)=>a+b.smart.rating,0)/rated.length).toFixed(1) : '-';
            document.getElementById('kpi-rating').innerText = avg + " / 5.0";
        }

        function renderCharts() {
            const names = filteredDB.map(c => c.name);
            const revenues = filteredDB.map(c => c.smart.revenue);

            if(charts.rev) charts.rev.destroy();
            charts.rev = new Chart(document.getElementById('revChart'), {
                type: 'bar',
                data: { labels: names, datasets: [{ label: 'Revenue ($M)', data: revenues, backgroundColor: '#2563eb', borderRadius: 4 }] },
                options: { maintainAspectRatio: false }
            });

            const regions = {};
            filteredDB.forEach(c => regions[c.smart.region] = (regions[c.smart.region]||0)+1);
            if(charts.geo) charts.geo.destroy();
            charts.geo = new Chart(document.getElementById('geoChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(regions), datasets: [{ data: Object.values(regions), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#64748b'] }] },
                options: { maintainAspectRatio: false }
            });
        }

        function switchView(view) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+view).classList.add('active');
            document.getElementById(view).classList.add('active');
            
            // Handle Settings Button Active State
            const settingsBtn = document.getElementById('btn-settings');
            if(view === 'settings') settingsBtn.classList.add('active');
            else settingsBtn.classList.remove('active');
        }

        function resetData() { if(confirm("Permanently delete all data?")) { localStorage.removeItem(DB_KEY); location.reload(); } }
    </script>
</body>
</html>