<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompeteBase PRO</title>
    
    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #6366f1; --accent-hover: #4f46e5;
            --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text-main: #1e293b;
            --text-light: #64748b; 
            
            /* Chart Colors */
            --c1: #3b82f6; --c2: #10b981; --c3: #f59e0b; --c4: #ef4444; 
            --c5: #8b5cf6; --c6: #ec4899; --c7: #06b6d4; --c8: #84cc16;

            /* Gradients */
            --header-grad: linear-gradient(135deg, #4f46e5, #3b82f6);
            --cat-grad: linear-gradient(90deg, #f1f5f9, #ffffff);
            --chat-header: linear-gradient(135deg, #6366f1, #a855f7);
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* NAVBAR */
        .navbar { height: 70px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; gap: 20px; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .logo { font-family: 'Outfit', sans-serif; font-size: 24px; font-weight: 800; text-decoration: none; background: linear-gradient(to right, #6366f1, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px; }
        
        .tabs { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 8px; margin-left: 40px; }
        .tab { padding: 8px 20px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; color: var(--text-light); transition: 0.2s; user-select: none; }
        .tab.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .nav-actions { display: flex; gap: 10px; margin-left: auto; }
        .btn { padding: 10px 18px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { border-color: var(--border); background: white; color: var(--text-main); }
        
        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; flex-shrink: 0; }
        .main { flex: 1; padding: 24px; overflow-y: auto; background: var(--bg); position: relative; }
        
        /* FILTERS */
        .filter-group { margin-bottom: 20px; }
        .filter-label { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px; display: block; }
        .sidebar-select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: #f8fafc; outline: none; transition: 0.2s; }
        .range-inputs { display: flex; gap: 10px; align-items: center; }
        .range-input { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }

        /* VIEWS */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* MAIN LIST TABLE */
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 300px; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; }
        
        .main-table th { background: #f1f5f9; text-align: left; padding: 16px; font-size: 12px; font-weight: 700; color: var(--secondary); text-transform: uppercase; border-bottom: 2px solid #e2e8f0; white-space: nowrap; cursor: pointer; user-select: none; }
        .main-table th:hover { background: #e2e8f0; color: var(--accent); }
        .main-table td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
        .main-table tr:hover { background: #f8fafc; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .product-tag { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin: 2px; font-weight: 500; }

        /* ANALYTICS GRID SYSTEM */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            padding-bottom: 40px;
        }
        .chart-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .chart-card h4 {
            margin: 0 0 15px 0;
            font-size: 14px;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }
        .chart-canvas-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        /* COMPARISON TABLE */
        .compare-view { position: fixed; inset: 0; background: #f0f4f8; z-index: 150; display: none; flex-direction: column; }
        .comp-header { padding: 15px 30px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 20; }
        .comp-table-wrapper { flex: 1; overflow: auto; padding: 30px; }
        .comp-table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); table-layout: fixed; }
        .comp-table th { background: var(--header-grad); color: white; position: sticky; top: 0; z-index: 30; padding: 20px; min-width: 240px; text-align: left; border-right: 1px solid rgba(255,255,255,0.1); }
        .comp-table th:first-child { position: sticky; left: 0; z-index: 40; border-right: 1px solid rgba(255,255,255,0.2); }
        .comp-name { font-size: 14px; font-weight: 700; color: white; letter-spacing: 0.5px; }
        .comp-cat-row td { background: var(--cat-grad); color: #334155; font-weight: 800; text-transform: uppercase; padding: 12px 20px; border-left: 5px solid var(--accent); border-bottom: 1px solid #cbd5e1; font-size: 12px; letter-spacing: 1px; }
        .comp-table td { padding: 16px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #f1f5f9; vertical-align: top; font-size: 13px; line-height: 1.6; background: white; color: var(--text-main); }
        .comp-table td:first-child { position: sticky; left: 0; z-index: 10; background: #f8fafc; font-weight: 600; color: #475569; border-right: 2px solid #e2e8f0; }
        .remove-col-btn { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); border: none; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; float: right; transition: 0.2s; }
        .remove-col-btn:hover { background: #ef4444; color: white; transform: scale(1.1); }

        /* CHATBOT */
        .chat-fab { position: fixed; bottom: 30px; right: 30px; background: var(--chat-header); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; cursor: pointer; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); z-index: 9999; transition: transform 0.2s; }
        .chat-fab:hover { transform: scale(1.05); }
        .chat-window { position: fixed; bottom: 100px; right: 30px; width: 360px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 20px 40px -5px rgba(0,0,0,0.15); z-index: 9999; display: none; flex-direction: column; overflow: hidden; border: 1px solid var(--border); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chat-header { background: var(--chat-header); color: white; padding: 18px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 12px; }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: white; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; font-size: 13px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg-user { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-bot { background: white; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid var(--border); }
        .typing-indicator { font-style: italic; color: #94a3b8; font-size: 12px; margin-left: 10px; display: none; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 450px; padding: 30px; border-radius: 16px; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        /* DRAWER */
        .drawer { position: fixed; top: 0; right: -650px; width: 650px; bottom: 0; background: white; z-index: 100; transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -10px 0 40px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; display: none; }
        .fab-compare { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 28px; border-radius: 50px; font-weight: 600; cursor: pointer; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.3); display: none; align-items: center; gap: 12px; z-index: 80; animation: bounceIn 0.3s; }
        @keyframes bounceIn { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        .bg-c1 { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .bg-c2 { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-c3 { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .bg-c4 { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .bg-c5 { background: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; }
        .bg-c6 { background: #fce7f3; color: #9d174d; border: 1px solid #fbcfe8; }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <a href="#" class="logo">
            <i class="fa-solid fa-brain"></i> CompeteBase
        </a>
        
        <div class="tabs">
            <div class="tab active" onclick="switchView('list')">Home Visit</div>
            <div class="tab" onclick="switchView('analytics')">Analytics</div>
            <div class="tab" onclick="switchView('settings')">Settings</div>
        </div>

        <div class="nav-actions">
            <input type="file" id="fileInput" hidden accept=".xlsx" onchange="processExcel(this)">
            <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up"></i> Upload Data
            </button>
            <button class="btn btn-accent" onclick="initDownload('selection')">
                <i class="fa-solid fa-download"></i> Export
            </button>
        </div>
    </div>

    <div class="layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <h3 style="margin-top:0; font-size:13px; border-bottom:1px solid #eee; padding-bottom:10px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">Filters</h3>
            
            <div class="filter-group">
                <label class="filter-label">1. Region</label>
                <select id="f-region" class="sidebar-select" onchange="updateCountryFilter()">
                    <option value="All">All Regions</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">2. Country</label>
                <select id="f-country" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Countries</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">3. Core Product</label>
                <select id="f-core" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Products</option>
                </select>
            </div>

            <!-- ADDED INDUSTRY FILTER -->
            <div class="filter-group">
                <label class="filter-label">4. Industry</label>
                <select id="f-industry" class="sidebar-select" onchange="applyFilters()">
                    <option value="All">All Industries</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">5. Employees</label>
                <div class="range-inputs">
                    <input type="number" id="f-emp-min" placeholder="Min" class="range-input" onkeyup="applyFilters()">
                    <input type="number" id="f-emp-max" placeholder="Max" class="range-input" onkeyup="applyFilters()">
                </div>
            </div>

            <!-- ADDED REVENUE FILTER -->
            <div class="filter-group">
                <label class="filter-label">6. Revenue ($M)</label>
                <div class="range-inputs">
                    <input type="number" id="f-rev-min" placeholder="Min" class="range-input" onkeyup="applyFilters()">
                    <input type="number" id="f-rev-max" placeholder="Max" class="range-input" onkeyup="applyFilters()">
                </div>
            </div>

            <button class="btn btn-outline" style="width:100%; justify-content:center; margin-top:20px;" onclick="resetFilters()">
                <i class="fa-solid fa-rotate-left"></i> Reset
            </button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            
            <!-- VIEW 1: HOME LIST -->
            <div id="list" class="view-section active">
                <div class="toolbar">
                    <input type="text" id="globalSearch" class="search-input" placeholder="Search companies..." onkeyup="applyFilters()">
                    <div style="font-size:13px; color:var(--text-light); padding-top:8px;">
                        Showing <b id="count-display" style="color:var(--text-main);">0</b> results
                    </div>
                </div>

                <div class="table-container">
                    <table class="main-table">
                        <thead>
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAllBox" onchange="toggleSelectAll(this)"></th>
                                <th onclick="sortDB('id')">ID <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('name')">Company <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('region')">Region <i class="fa-solid fa-sort"></i></th>
                                <th>Core Products</th>
                                <th onclick="sortDB('industry')">Industry <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('employees')">Employees <i class="fa-solid fa-sort"></i></th>
                                <th onclick="sortDB('revenue')">Revenue <i class="fa-solid fa-sort"></i></th>
                                <th width="80">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                    <div id="empty-state" style="padding:60px; text-align:center; display:none; color:var(--text-light);">
                        <i class="fa-regular fa-folder-open" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
                        <p>No data found. Upload an Excel file.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ANALYTICS DASHBOARD -->
            <div id="analytics" class="view-section">
                <div class="analytics-grid">
                    <!-- Charts will be injected here -->
                    <div class="chart-card">
                        <h4>Regional Distribution</h4>
                        <div class="chart-canvas-container"><canvas id="c-region"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Type of Company</h4>
                        <div class="chart-canvas-container"><canvas id="c-type"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Employees</h4>
                        <div class="chart-canvas-container"><canvas id="c-emp"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Distributors Count</h4>
                        <div class="chart-canvas-container"><canvas id="c-dist"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Warehouses Count</h4>
                        <div class="chart-canvas-container"><canvas id="c-ware"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Global Presence</h4>
                        <div class="chart-canvas-container"><canvas id="c-pres"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Current Products</h4>
                        <div class="chart-canvas-container"><canvas id="c-prod"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Discontinued</h4>
                        <div class="chart-canvas-container"><canvas id="c-disc"></canvas></div>
                    </div>
                    <div class="chart-card" style="grid-column: span 2;">
                        <h4>Core Products Frequency</h4>
                        <div class="chart-canvas-container"><canvas id="c-core"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: SETTINGS -->
            <div id="settings" class="view-section">
                <div class="settings-list" style="max-width:800px; margin:0 auto; border:1px solid #e2e8f0; border-radius:12px; background:white; overflow:hidden;">
                    <div style="background:#fef2f2; padding:20px; border-bottom:1px solid #fee2e2;">
                        <strong style="color:#dc2626; display:flex; align-items:center; gap:10px;">
                            <i class="fa-solid fa-triangle-exclamation"></i> Danger Zone
                        </strong>
                        <div style="font-size:13px; color:#b91c1c; margin-top:5px;">Permanently delete specific companies.</div>
                    </div>
                    <div style="padding:25px;">
                        <input type="text" id="deleteSearch" placeholder="Type company name to search..." class="search-input" style="width:100%;" onkeyup="renderSettings()">
                        <div id="delete-list" style="margin-top:15px; max-height:400px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- AI CHATBOT ICON -->
    <div class="chat-fab" onclick="toggleChat()">
        <i class="fa-solid fa-robot"></i>
    </div>
    
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <span style="display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-robot"></i> CompeteAI</span>
            <span onclick="toggleChat()" style="cursor:pointer; opacity:0.8;">&times;</span>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="msg msg-bot">
                Hello! Ask me about revenue, employees, or summaries.
            </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">AI is thinking...</div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ask a question..." style="flex:1; border:none; outline:none; font-size:13px;" onkeypress="handleChatEnter(event)">
            <button class="btn btn-accent" style="padding:8px 12px;" onclick="handleChat()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- FLOATING COMPARE BUTTON -->
    <div class="fab-compare" id="compareFab" onclick="openCompareView()">
        <i class="fa-solid fa-scale-balanced"></i> Compare (<span id="compCount">0</span>)
    </div>

    <!-- DETAILS DRAWER -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="detailsDrawer">
        <div style="padding:25px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2 id="d-name" style="margin:0; color:var(--primary);">Company</h2>
                <div id="d-meta" style="font-size:12px; color:var(--text-light); margin-top:4px;"></div>
            </div>
            <button class="btn btn-outline" onclick="closeDrawer()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="d-content" style="padding:25px; overflow-y:auto; background:#f8fafc; height:100%;"></div>
    </div>

    <!-- COMPARISON VIEW -->
    <div class="compare-view" id="compareView">
        <div class="comp-header">
            <h3 style="margin:0; color:var(--primary); display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-scale-balanced" style="color:var(--accent);"></i> Head-to-Head Comparison
            </h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="openAddModal()">
                    <i class="fa-solid fa-plus"></i> Add
                </button>
                <button class="btn btn-accent" onclick="initDownload('comparison')">
                    <i class="fa-solid fa-download"></i> Export
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('compareView').classList.remove('open')">
                    Close
                </button>
            </div>
        </div>
        <div class="comp-table-wrapper">
            <table class="comp-table" id="compTable"></table>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="addModal">
        <div class="modal-box">
            <h3 style="margin-top:0;">Add to Comparison</h3>
            <input type="text" id="addSearch" class="search-input" style="width:100%; margin-bottom:15px;" placeholder="Search..." onkeyup="renderAddList()">
            <div id="add-list" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px;"></div>
            <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="document.getElementById('addModal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div class="modal" id="dlModal">
        <div class="modal-box" style="text-align:center;">
            <h3 style="margin-top:0;">Export Data</h3>
            <p style="color:#64748b; font-size:13px;">Choose your preferred format:</p>
            <div style="display:flex; justify-content:center; gap:20px; margin-top:25px;">
                <button class="btn btn-outline" onclick="executeDownload('pdf')" style="flex-direction:column; padding:25px; width:120px;">
                    <i class="fa-regular fa-file-pdf" style="font-size:28px; margin-bottom:10px; color:#ef4444;"></i>
                    PDF Report
                </button>
                <button class="btn btn-outline" onclick="executeDownload('excel')" style="flex-direction:column; padding:25px; width:120px;">
                    <i class="fa-regular fa-file-excel" style="font-size:28px; margin-bottom:10px; color:#10b981;"></i>
                    Excel Data
                </button>
            </div>
            <button class="btn btn-primary" style="margin-top:25px; width:100%;" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const DB_KEY = 'compete_db_pro_v7';
        let db = [];
        let filteredDB = [];
        let selectedIDs = new Set();
        let currentSort = { col: null, dir: 'asc' };
        let charts = {};
        
        // Palette
        const colors = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
            '#ec4899', '#06b6d4', '#84cc16', '#6366f1', '#14b8a6'
        ];

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) db = JSON.parse(saved);
            filteredDB = [...db];
            populateFilters();
            applyFilters();
        });

        // --- EXCEL PARSER ---
        function processExcel(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval:""});
                
                if(rows.length < 3) return alert("File format incorrect.");

                const companies = [];
                let nameRowIdx = rows.findIndex(r => (r[1]||"").toLowerCase().trim() === 'company name');
                if(nameRowIdx === -1) nameRowIdx = 2; 

                for(let c = 2; c < rows[0].length; c++) {
                    if(!rows[nameRowIdx][c]) continue;
                    companies.push({
                        tempIdx: c,
                        id: "", name: "", region: "", country: "", // Region defaults to empty
                        industry: "Unknown", type: "Unknown", coreProduct: "-", revenue: 0, employees: 0,
                        stats: { distributors: 0, warehouses: 0, presence: 0, products: 0, discontinued: 0 },
                        data: []
                    });
                }

                // Parse Data
                for(let r = 0; r < rows.length; r++) {
                    const cat = (rows[r][0] || "").trim();
                    const key = (rows[r][1] || "").trim();
                    if(!key) continue;

                    companies.forEach(comp => {
                        let val = rows[r][comp.tempIdx];
                        if(val === undefined || val === null) val = "-";
                        val = String(val).trim();

                        if(val && val !== "-") comp.data.push({ cat: cat || "General", key: key, val: val });

                        const kl = key.toLowerCase();
                        if(kl === 'company name') comp.name = val;
                        if(kl === 'company id') comp.id = val;
                        if(kl.includes('core product')) comp.coreProduct = val;
                        if(kl === 'industry') comp.industry = val;
                        if(kl === 'type of company') comp.type = val;
                        
                        // RAW REGION logic
                        if(kl === 'region') comp.region = val; 

                        // Fallback: If Region isn't set, try location but don't map it
                        if(kl === 'headquarters' || kl === 'location') {
                            if(!comp.region) comp.region = val; // Use raw
                            if(val.includes(',')) comp.country = val.split(',').pop().trim();
                            else comp.country = val;
                        }

                        if(kl.includes('revenue')) comp.revenue = parseMoney(val);
                        if((kl.includes('employee') || kl.includes('staff')) && !kl.includes('range')) comp.employees = parseNum(val);
                        
                        if(kl.includes('distributors')) comp.stats.distributors = extractNum(val);
                        if(kl.includes('warehouses')) comp.stats.warehouses = extractNum(val);
                        if(kl.includes('presence')) comp.stats.presence = extractNum(val);
                        if(kl.includes('total current products')) comp.stats.products = extractNum(val);
                        if(kl.includes('discontinued products')) comp.stats.discontinued = extractNum(val);
                    });
                }

                companies.forEach(c => {
                    if(!c.id || c.id === '-') c.id = Math.abs(strHash(c.name)).toString().substring(0,6);
                    if(!c.region) c.region = "Other"; // Final fallback
                    delete c.tempIdx;
                    const idx = db.findIndex(x => x.id === c.id);
                    if(idx >= 0) db[idx] = c; else db.push(c);
                });

                saveDB();
                populateFilters();
                applyFilters();
                switchView('list');
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        // --- FILTERS ---
        function populateFilters() {
            const regions = [...new Set(db.map(x => x.region))].sort();
            fillSelect('f-region', regions);
            
            const countries = [...new Set(db.map(x => x.country).filter(Boolean))].sort();
            fillSelect('f-country', countries);
            
            const rawProds = db.map(x => x.coreProduct).filter(Boolean);
            const splitProds = rawProds.flatMap(p => p.split(',').map(s => s.trim()));
            const uniqueProds = [...new Set(splitProds)].sort();
            fillSelect('f-core', uniqueProds);

            const inds = [...new Set(db.map(x => x.industry))].sort();
            fillSelect('f-industry', inds);
        }

        function updateCountryFilter() {
            const r = document.getElementById('f-region').value;
            const available = r === 'All' ? db : db.filter(x => x.region === r);
            const countries = [...new Set(available.map(x => x.country))].sort();
            fillSelect('f-country', countries);
            applyFilters();
        }

        function fillSelect(id, items) {
            const sel = document.getElementById(id);
            const curr = sel.value;
            let lbl = "Items";
            if(id.includes('region')) lbl="Regions"; else if(id.includes('country')) lbl="Countries"; else if(id.includes('core')) lbl="Products"; else if(id.includes('industry')) lbl="Industries";
            sel.innerHTML = `<option value="All">All ${lbl}</option>`;
            items.forEach(i => { if(i && i !== '-') sel.innerHTML += `<option value="${i}">${i}</option>`; });
            if(items.includes(curr)) sel.value = curr;
        }

        function applyFilters() {
            const reg = document.getElementById('f-region').value;
            const cnt = document.getElementById('f-country').value;
            const core = document.getElementById('f-core').value;
            const ind = document.getElementById('f-industry').value;
            const eMin = parseFloat(document.getElementById('f-emp-min').value) || 0;
            const eMax = parseFloat(document.getElementById('f-emp-max').value) || Infinity;
            const rMin = parseFloat(document.getElementById('f-rev-min').value) || 0;
            const rMax = parseFloat(document.getElementById('f-rev-max').value) || Infinity;
            const q = document.getElementById('globalSearch').value.toLowerCase();

            filteredDB = db.filter(c => {
                if(reg !== 'All' && c.region !== reg) return false;
                if(cnt !== 'All' && c.country !== cnt) return false;
                if(ind !== 'All' && c.industry !== ind) return false;
                if(core !== 'All' && !c.coreProduct.toLowerCase().includes(core.toLowerCase())) return false;
                if(c.employees < eMin || c.employees > eMax) return false;
                if(c.revenue < rMin || c.revenue > rMax) return false;
                if(q && !JSON.stringify(c).toLowerCase().includes(q)) return false;
                return true;
            });

            document.getElementById('count-display').innerText = filteredDB.length;
            if(document.getElementById('list').classList.contains('active')) renderTable();
            if(document.getElementById('analytics').classList.contains('active')) renderAllCharts();
        }

        function resetFilters() {
            document.querySelectorAll('select').forEach(s => s.value='All');
            document.querySelectorAll('input').forEach(i => i.value='');
            populateFilters();
            applyFilters();
        }

        // --- TABLE ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(filteredDB.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            }
            document.getElementById('empty-state').style.display = 'none';

            filteredDB.forEach(c => {
                let pHtml = '';
                if(c.coreProduct && c.coreProduct !== '-') {
                    c.coreProduct.split(',').slice(0, 3).forEach((p, i) => {
                        const colorClass = `bg-c${(i % 6) + 1}`;
                        pHtml += `<span class="product-tag ${colorClass}">${p.trim()}</span>`;
                    });
                } else pHtml = '-';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:center;"><input type="checkbox" class="row-cb" value="${c.id}" onchange="toggleSelect('${c.id}')" ${selectedIDs.has(c.id)?'checked':''}></td>
                    <td style="font-family:monospace; color:#64748b;">${c.id}</td>
                    <td style="font-weight:600; color:var(--primary);">${c.name}</td>
                    <td><span class="badge">${c.region}</span></td>
                    <td>${pHtml}</td>
                    <td>${c.industry}</td>
                    <td>${c.employees.toLocaleString()}</td>
                    <td>$${c.revenue.toLocaleString()}M</td>
                    <td><button class="btn btn-outline" style="padding:5px 10px; font-size:11px;" onclick="showDetails('${c.id}')">View</button></td>
                `;
                tbody.appendChild(tr);
            });
            checkSelectAllBox();
        }

        function sortDB(col) {
            if(currentSort.col === col) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            else currentSort = { col: col, dir: 'asc' };
            
            filteredDB.sort((a,b) => {
                let vA = a[col], vB = b[col];
                if(typeof vA === 'string') vA = vA.toLowerCase();
                if(typeof vB === 'string') vB = vB.toLowerCase();
                if(vA < vB) return currentSort.dir === 'asc' ? -1 : 1;
                if(vA > vB) return currentSort.dir === 'asc' ? 1 : -1;
                return 0;
            });
            renderTable();
        }

        // --- ANALYTICS DASHBOARD ---
        function renderAllCharts() {
            // Helper: Bar Chart
            const createBar = (id, label, dataKey, isStat=false) => {
                if(charts[id]) charts[id].destroy();
                const labs = filteredDB.map(c => c.name);
                const data = filteredDB.map(c => isStat ? (c.stats[dataKey]||0) : c[dataKey]);
                const bg = labs.map((_, i) => colors[i % colors.length]);
                
                charts[id] = new Chart(document.getElementById(id), {
                    type: 'bar',
                    data: { labels: labs, datasets: [{ label: label, data: data, backgroundColor: bg, borderRadius:6 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            };

            // 1. Regional Dist (Pie)
            const rCounts = {}; filteredDB.forEach(c => rCounts[c.region]=(rCounts[c.region]||0)+1);
            if(charts['c-region']) charts['c-region'].destroy();
            charts['c-region'] = new Chart(document.getElementById('c-region'), {
                type: 'doughnut',
                data: { labels: Object.keys(rCounts), datasets: [{ data: Object.values(rCounts), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 2. Type of Company (Pie)
            const tCounts = {}; filteredDB.forEach(c => tCounts[c.type||"Unknown"]=(tCounts[c.type||"Unknown"]||0)+1);
            if(charts['c-type']) charts['c-type'].destroy();
            charts['c-type'] = new Chart(document.getElementById('c-type'), {
                type: 'pie',
                data: { labels: Object.keys(tCounts), datasets: [{ data: Object.values(tCounts), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 3. Employees (Bar)
            createBar('c-emp', 'Employees', 'employees');

            // 4. Distributors (Bar)
            createBar('c-dist', 'Distributors', 'distributors', true);

            // 5. Warehouses (Bar)
            createBar('c-ware', 'Warehouses', 'warehouses', true);

            // 6. Global Presence (Bar)
            createBar('c-pres', 'Global Presence', 'presence', true);

            // 7. Products (Bar)
            createBar('c-prod', 'Total Products', 'products', true);

            // 8. Discontinued (Bar)
            createBar('c-disc', 'Discontinued', 'discontinued', true);

            // 9. Core Product Freq (Polar)
            const pCounts = {};
            filteredDB.forEach(c => {
                if(c.coreProduct && c.coreProduct !== '-') {
                    c.coreProduct.split(',').forEach(p => { const t = p.trim(); pCounts[t] = (pCounts[t]||0)+1; });
                }
            });
            if(charts['c-core']) charts['c-core'].destroy();
            charts['c-core'] = new Chart(document.getElementById('c-core'), {
                type: 'polarArea',
                data: { labels: Object.keys(pCounts), datasets: [{ data: Object.values(pCounts), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        // --- CHATBOT ---
        function toggleChat() {
            const win = document.getElementById('chatWindow');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }
        function handleChatEnter(e) { if(e.key === 'Enter') handleChat(); }

        function handleChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim().toLowerCase();
            if(!msg) return;

            addMsg(input.value, 'user');
            input.value = '';

            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';

            setTimeout(() => {
                indicator.style.display = 'none';
                let response = "I didn't quite catch that. Try asking about revenue, employees, or summaries.";

                if(msg.includes('hello') || msg.includes('hi')) {
                    response = "Hi there! I'm ready to analyze your competitor data.";
                } else if(msg.includes('summarize') || msg.includes('tell me about')) {
                    const target = db.find(c => msg.includes(c.name.toLowerCase()));
                    if(target) {
                        response = `<b>${target.name}</b> (${target.type}) is based in <b>${target.region}</b>. Revenue: <b>$${target.revenue}M</b>. Employees: <b>${target.employees}</b>. Core: ${target.coreProduct}.`;
                    } else {
                        response = "I couldn't find that company.";
                    }
                } else if(msg.includes('most') || msg.includes('highest')) {
                    if(msg.includes('employee')) {
                        const top = [...db].sort((a,b)=>b.employees - a.employees)[0];
                        response = `<b>${top.name}</b> is the largest employer with ${top.employees.toLocaleString()} staff.`;
                    } else if(msg.includes('revenue')) {
                        const top = [...db].sort((a,b)=>b.revenue - a.revenue)[0];
                        response = `<b>${top.name}</b> leads in revenue with $${top.revenue}M.`;
                    }
                } 
                addMsg(response, 'bot');
            }, 800);
        }

        function addMsg(text, type) {
            const body = document.getElementById('chatBody');
            const div = document.createElement('div');
            div.className = `msg msg-${type}`;
            div.innerHTML = text;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        // --- COMPARISON ---
        function getCatIcon(cat) {
            const c = cat.toLowerCase();
            let icon = 'fa-layer-group';
            if(c.includes('swot')) icon = 'fa-shield-halved';
            else if(c.includes('finance') || c.includes('revenue')) icon = 'fa-coins';
            else if(c.includes('hr') || c.includes('employ')) icon = 'fa-users';
            else if(c.includes('product') || c.includes('core')) icon = 'fa-box-open';
            return `<i class="fa-solid ${icon}" style="margin-right:8px; opacity:0.8;"></i>`;
        }

        function openCompareView() {
            if(selectedIDs.size < 1) return alert("Select at least 1 company.");
            const comps = db.filter(c => selectedIDs.has(c.id));
            const table = document.getElementById('compTable');
            const keyMap = {}; 
            
            comps.forEach(c => {
                c.data.forEach(d => {
                    const ck = d.key.toLowerCase();
                    if(ck.includes('competitor') || ck === 'data point') return; 
                    if(!keyMap[d.cat]) keyMap[d.cat] = new Set();
                    keyMap[d.cat].add(d.key);
                });
            });

            let html = `<thead><tr><th style="border-top-left-radius:12px;">Data Point</th>`;
            comps.forEach((c, i) => {
                const rStyle = i === comps.length-1 ? 'border-top-right-radius:12px;' : '';
                html += `<th style="${rStyle}"><div style="display:flex; justify-content:space-between; align-items:center;"><span class="comp-name">${c.name}</span><button class="remove-col-btn" onclick="removeFromCompare('${c.id}')"><i class="fa-solid fa-xmark"></i></button></div></th>`;
            });
            html += `</tr></thead><tbody>`;

            html += `<tr class="comp-cat-row"><td colspan="${comps.length+1}">${getCatIcon('General')} OVERVIEW</td></tr>`;
            html += `<tr><td><b>Region</b></td>${comps.map(c=>`<td><span class="badge">${c.region}</span></td>`).join('')}</tr>`;
            html += `<tr><td><b>Revenue</b></td>${comps.map(c=>`<td style="font-weight:700; color:#0f172a;">$${c.revenue.toLocaleString()}M</td>`).join('')}</tr>`;
            html += `<tr><td><b>Employees</b></td>${comps.map(c=>`<td>${c.employees.toLocaleString()}</td>`).join('')}</tr>`;
            
            for(const [cat, keys] of Object.entries(keyMap)) {
                html += `<tr class="comp-cat-row"><td colspan="${comps.length+1}">${getCatIcon(cat)} ${cat}</td></tr>`;
                keys.forEach(k => {
                    html += `<tr><td style="color:#475569; font-weight:600;">${k}</td>`;
                    comps.forEach(c => {
                        const dp = c.data.find(d => d.cat === cat && d.key === k);
                        html += `<td>${dp ? dp.val : '-'}</td>`;
                    });
                    html += `</tr>`;
                });
            }

            table.innerHTML = html + "</tbody>";
            document.getElementById('compareView').classList.add('open');
        }

        function removeFromCompare(id) {
            toggleSelect(id);
            if(selectedIDs.size < 1) document.getElementById('compareView').classList.remove('open');
            else openCompareView();
        }

        // --- SHARED UTILS ---
        function toggleSelectAll(source) {
            document.querySelectorAll('.row-cb').forEach(cb => { cb.checked = source.checked; toggleSelect(cb.value, false); });
            updateFab();
        }
        function toggleSelect(id, updateUI=true) {
            if(selectedIDs.has(id)) selectedIDs.delete(id); else selectedIDs.add(id);
            if(updateUI) updateFab();
        }
        function checkSelectAllBox() {
            const all = filteredDB.length > 0 && filteredDB.every(c => selectedIDs.has(c.id));
            document.getElementById('selectAllBox').checked = all;
        }
        function updateFab() {
            document.getElementById('compCount').innerText = selectedIDs.size;
            document.getElementById('compareFab').style.display = selectedIDs.size > 0 ? 'flex' : 'none';
        }
        function showDetails(id) {
            const c = db.find(x => x.id === id);
            if(!c) return;
            document.getElementById('d-name').innerText = c.name;
            document.getElementById('d-meta').innerText = `${c.region} | ${c.industry}`;
            let html = ``;
            const groups = {};
            c.data.forEach(d => { if(!groups[d.cat]) groups[d.cat]=[]; groups[d.cat].push(d); });
            for(const [cat, items] of Object.entries(groups)) {
                html += `<div style="background:white; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;"><h4 style="margin:0 0 15px 0; color:var(--accent); font-size:12px; text-transform:uppercase;">${cat}</h4>`;
                items.forEach(i => { html += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px; border-bottom:1px dashed #f1f5f9; padding-bottom:5px;"><span style="font-weight:500; color:#475569;">${i.key}</span><span style="text-align:right; max-width:60%; color:#1e293b;">${i.val}</span></div>`; });
                html += `</div>`;
            }
            document.getElementById('d-content').innerHTML = html;
            document.getElementById('drawerOverlay').style.display = 'block';
            setTimeout(() => document.getElementById('detailsDrawer').classList.add('open'), 10);
        }
        function closeDrawer() { document.getElementById('detailsDrawer').classList.remove('open'); setTimeout(() => document.getElementById('drawerOverlay').style.display = 'none', 300); }
        function switchView(view) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active'); document.getElementById(view).classList.add('active');
            if(view === 'analytics') renderAllCharts(); if(view === 'list') renderTable();
        }
        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        function strHash(s) { let h=0; for(let i=0;i<s.length;i++) h = Math.imul(31,h)+s.charCodeAt(i)|0; return h; }
        function parseMoney(s) { const m = s.match(/(\d+(\.\d+)?)/); return m ? parseFloat(m[0]) : 0; }
        function parseNum(s) { return parseInt(s.replace(/,/g,'').replace(/\D/g, '')) || 0; }
        function extractNum(val) { if(!val) return 0; const match = String(val).replace(/,/g,'').match(/\d+/); return match ? parseInt(match[0]) : 0; }
        function openAddModal() { document.getElementById('addModal').style.display = 'flex'; renderAddList(); }
        function closeModal() { document.getElementById('dlModal').style.display='none'; document.getElementById('addModal').style.display='none'; }
        function renderAddList() {
            const q = document.getElementById('addSearch').value.toLowerCase();
            const list = document.getElementById('add-list');
            list.innerHTML = '';
            const available = db.filter(c => !selectedIDs.has(c.id) && (c.name.toLowerCase().includes(q) || c.id.toLowerCase().includes(q)));
            if(available.length === 0) { list.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">No companies found.</div>'; return; }
            available.forEach(c => {
                const div = document.createElement('div');
                div.style.padding = '12px'; div.style.borderBottom = '1px solid #f1f5f9'; div.style.cursor = 'pointer'; div.style.display = 'flex'; div.style.justifyContent = 'space-between';
                div.innerHTML = `<span>${c.name}</span>`;
                div.onclick = () => { toggleSelect(c.id, true); openCompareView(); renderAddList(); };
                list.appendChild(div);
            });
        }
        function renderSettings() {
            const q = document.getElementById('deleteSearch').value.toLowerCase();
            const list = document.getElementById('delete-list');
            list.innerHTML = '';
            const matches = db.filter(c => c.name.toLowerCase().includes(q) || c.id.toLowerCase().includes(q));
            if(matches.length === 0) { list.innerHTML = "<div style='padding:10px; color:#888;'>No matches found.</div>"; return; }
            matches.forEach(m => {
                const div = document.createElement('div'); div.style.padding = "10px"; div.style.borderBottom = "1px solid #eee"; div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.alignItems = "center";
                div.innerHTML = `<span><b>${m.name}</b> (${m.id})</span>`;
                const btn = document.createElement('button'); btn.className = 'btn btn-danger'; btn.style.padding = '4px 8px'; btn.style.fontSize = '11px'; btn.innerText = 'Delete';
                btn.onclick = () => { if(confirm("Are you sure?")) { db = db.filter(c => c.id !== m.id); saveDB(); location.reload(); } };
                div.appendChild(btn); list.appendChild(div);
            });
        }
        function initDownload(type) { if(selectedIDs.size === 0) return alert("No companies selected."); currentDlType = type; document.getElementById('dlModal').style.display = 'flex'; }
        function executeDownload(format) {
            closeModal();
            const targets = db.filter(c => selectedIDs.has(c.id));
            if(format === 'pdf') { if(targets.length > 5) return alert("PDF export limited to 5 companies."); generatePDF(targets); } else generateExcel(targets);
        }
        function generateExcel(data) {
            const wb = XLSX.utils.book_new();
            const summaryData = data.map(c => ({ "ID": c.id, "Name": c.name, "Region": c.region, "Core Product": c.coreProduct, "Industry": c.industry, "Revenue": c.revenue, "Employees": c.employees }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryData), "Summary");
            const flatData = data.map(c => { const flat = { "ID": c.id, "Name": c.name }; c.data.forEach(d => flat[`${d.cat} - ${d.key}`] = d.val); return flat; });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(flatData), "Detailed Data");
            XLSX.writeFile(wb, "CompeteBase_Export.xlsx");
        }
        function generatePDF(data) {
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(18); doc.text("Competitor Analysis Report", 14, 20);
            data.forEach((c, index) => {
                if(index > 0) doc.addPage();
                doc.setFontSize(14); doc.setTextColor(37, 99, 235); doc.text(`${c.name} (${c.id})`, 14, 30);
                doc.setTextColor(0); doc.setFontSize(10); doc.text(`Region: ${c.region} | Core: ${c.coreProduct} | Rev: $${c.revenue}M`, 14, 36);
                doc.autoTable({ startY: 40, head: [['Category', 'Metric', 'Value']], body: c.data.map(d => [d.cat, d.key, d.val]), theme: 'grid' });
            });
            doc.save("Competitor_Report.pdf");
        }
    </script>
</body>
</html>